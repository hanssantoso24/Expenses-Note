<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Advanced Personal Finance Management System with real-time exchange rates and utility monitoring">
    <meta name="keywords" content="finance, budgeting, investment, utility tracking, THB, IDR">
    <meta name="author" content="Hans Financial Note">
    <title>Hans Financial Note | Advanced Personal Finance Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <!-- Firebase SDK (optional - for cloud sync) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --light-blue: #60a5fa;
            --dark-blue: #1e3a8a;
            --white: #ffffff;
            --off-white: #f8fafc;
            --light-gray: #f1f5f9;
            --medium-gray: #e2e8f0;
            --dark-gray: #475569;
            --gold-primary: #f59e0b;
            --gold-secondary: #fbbf24;
            --gold-light: #fcd34d;
            --success: #10b981;
            --success-light: #a7f3d0;
            --warning: #f59e0b;
            --warning-light: #fde68a;
            --danger: #ef4444;
            --danger-light: #fecaca;
            --purple: #8b5cf6;
            --teal: #14b8a6;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --gradient-primary: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        @supports (font-variation-settings: normal) {
            * {
                font-family: 'Inter var', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            }
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Container */
        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header & Navigation */
        .app-header {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: 0 10px 40px rgba(30, 64, 175, 0.1);
            margin-bottom: 30px;
            padding: 25px 30px;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 4px;
        }

        .logo-text .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-blue);
        }

        /* Exchange Rate Banner */
        .exchange-banner {
            background: var(--gradient-primary);
            color: white;
            padding: 20px 25px;
            border-radius: var(--radius-lg);
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(30, 64, 175, 0.2);
            position: relative;
            overflow: hidden;
        }

        .exchange-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
        }

        .exchange-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .rate-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rate-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .rate-display {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .rate-value {
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .rate-currency {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .rate-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .rate-source {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rate-update {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .rate-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Balance Cards */
        .balance-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .balance-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 18px;
            box-shadow: 0 4px 15px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .balance-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.12);
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .balance-card.bank::before {
            background: var(--gradient-primary);
        }

        .balance-card.cash::before {
            background: var(--gradient-gold);
        }

        .balance-card.compact {
            padding: 15px;
        }

        .balance-card.compact .balance-header {
            margin-bottom: 12px;
        }

        .balance-card.compact .balance-icon {
            width: 36px;
            height: 36px;
            font-size: 1rem;
        }

        .balance-card.compact .balance-text h3 {
            font-size: 1rem;
        }

        .balance-card.compact .balance-thb {
            font-size: 1.6rem;
        }

        .balance-card.compact .balance-idr {
            font-size: 0.85rem;
        }

        .balance-card.compact .balance-details {
            display: none;
        }

        .balance-card.compact .balance-actions {
            margin-top: 12px;
            padding-top: 12px;
        }

        .balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .balance-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-icon {
            width: 40px;
            height: 40px;
            background: var(--light-gray);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            font-size: 1.1rem;
        }

        .balance-card.bank .balance-icon {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-blue);
        }

        .balance-card.cash .balance-icon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--gold-primary);
        }

        .balance-text h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .balance-status {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--success-light);
            color: var(--success);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Transaction Highlight Section */
        .transaction-highlight {
            background: linear-gradient(135deg, var(--white) 0%, #f0f7ff 100%);
            border-radius: var(--radius-xl);
            padding: 25px;
            box-shadow: 0 10px 40px rgba(30, 64, 175, 0.15);
            border: 2px solid var(--secondary-blue);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .transaction-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .transaction-highlight .card-header {
            margin-bottom: 20px;
        }

        .transaction-highlight .card-icon {
            background: var(--gradient-primary);
            color: white;
        }

        /* Cloud Sync Bar */
        .cloud-sync-bar {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .cloud-sync-bar.not-connected {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-status i {
            font-size: 1.2rem;
        }

        .sync-actions {
            display: flex;
            gap: 10px;
        }

        .sync-actions .btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }

        .sync-actions .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Image Upload Section */
        .image-upload-section {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
        }

        .image-upload-section:hover {
            border-color: var(--secondary-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .image-upload-section.has-image {
            border-style: solid;
            border-color: var(--success);
        }

        .image-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: var(--radius-sm);
            margin-top: 10px;
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .balance-amount {
            margin-bottom: 20px;
        }

        .balance-thb {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .balance-idr {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .balance-details {
            background: var(--light-gray);
            padding: 20px;
            border-radius: var(--radius-md);
            margin-top: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .balance-actions {
            margin-top: 25px;
            display: flex;
            gap: 12px;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 30px;
            box-shadow: 0 8px 30px var(--shadow);
            border: 1px solid var(--border);
            height: 100%;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: var(--light-gray);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            font-size: 1.1rem;
        }

        .card-text h3 {
            font-size: 1.4rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-label i {
            color: var(--text-secondary);
            width: 16px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--white);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-blue);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-with-icon {
            position: relative;
        }

        .input-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30, 64, 175, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-gold {
            background: var(--gradient-gold);
            color: white;
        }

        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--light-gray);
            border-color: var(--text-tertiary);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
            gap: 6px;
        }

        .btn-block {
            width: 100%;
            display: block;
        }

        /* Utility Tracking Cards */
        .utility-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 30px;
            box-shadow: 0 8px 30px var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 25px;
        }

        .utility-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .utility-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .utility-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .utility-icon.electricity {
            background: var(--gradient-primary);
        }

        .utility-icon.water {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
        }

        .utility-text h4 {
            font-size: 1.4rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .utility-rate {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .utility-last-update {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reading-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .reading-card {
            background: var(--light-gray);
            padding: 20px;
            border-radius: var(--radius-md);
        }

        .reading-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reading-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .reading-date {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .current-reading-input {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            width: 100%;
            transition: all 0.2s;
        }

        .current-reading-input:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .calculation-result {
            background: var(--off-white);
            padding: 25px;
            border-radius: var(--radius-lg);
            margin-top: 25px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .calc-item {
            background: var(--white);
            padding: 15px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .calc-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .calc-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .warning-alert {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
            padding: 15px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
        }

        /* Transactions Table */
        .transactions-section {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 30px;
            box-shadow: 0 8px 30px var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .table-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1000px;
        }

        .data-table th {
            background: var(--light-gray);
            color: var(--text-primary);
            font-weight: 600;
            padding: 18px 20px;
            text-align: left;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s;
        }

        .data-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.04);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--light-gray);
            color: var(--text-primary);
        }

        .badge-income {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-expense {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-transfer {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        /* Settings Panel */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .setting-group {
            background: var(--off-white);
            padding: 25px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .setting-title {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Setup Wizard */
        .setup-wizard {
            max-width: 900px;
            margin: 50px auto;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .wizard-progress {
            height: 4px;
            background: var(--light-gray);
            position: relative;
        }

        .wizard-progress-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }

        .wizard-content {
            padding: 40px;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px solid var(--border);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 35px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-modal:hover {
            background: var(--light-gray);
            color: var(--text-primary);
        }

        /* Footer */
        .app-footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 40px;
            font-size: 0.9rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--secondary-blue);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s ease;
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease;
        }

        .toast.hiding {
            transform: translateX(100%);
            opacity: 0;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-success {
            border-left-color: var(--success);
        }

        .toast-warning {
            border-left-color: var(--warning);
        }

        .toast-error {
            border-left-color: var(--danger);
        }

        .toast-info {
            border-left-color: var(--secondary-blue);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-success .toast-icon {
            color: var(--success);
        }

        .toast-warning .toast-icon {
            color: var(--warning);
        }

        .toast-error .toast-icon {
            color: var(--danger);
        }

        .toast-info .toast-icon {
            color: var(--secondary-blue);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .toast-close:hover {
            background: var(--light-gray);
            color: var(--text-primary);
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--light-gray) 25%, var(--medium-gray) 50%, var(--light-gray) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-md);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }

            .main-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .app-header {
                padding: 15px;
                margin-bottom: 15px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .logo-section {
                flex-direction: column;
                text-align: center;
            }

            .logo-text h1 {
                font-size: 1.5rem;
            }

            .header-stats {
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .header-stats .stat-item {
                flex: 1;
                min-width: 80px;
                align-items: center;
            }

            .exchange-banner {
                padding: 15px;
                margin-bottom: 15px;
            }

            .exchange-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .rate-value {
                font-size: 2rem;
            }

            .rate-controls {
                width: 100%;
                justify-content: center;
            }

            .balance-container {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .balance-card {
                padding: 12px;
            }

            .balance-card .balance-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .balance-card .balance-thb {
                font-size: 1.4rem;
            }

            .balance-card .balance-idr {
                font-size: 0.8rem;
            }

            .balance-card .balance-actions {
                flex-direction: column;
                gap: 5px;
            }

            .balance-card .balance-actions .btn {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            .balance-details {
                display: none;
            }

            .transaction-highlight {
                padding: 15px;
                margin-bottom: 15px;
            }

            .transaction-highlight .card-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .cloud-sync-bar {
                flex-direction: column;
                text-align: center;
                padding: 10px 15px;
            }

            .sync-actions {
                width: 100%;
                justify-content: center;
            }

            .card {
                padding: 15px;
            }

            .card-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .form-group {
                margin-bottom: 12px;
            }

            .form-control {
                padding: 12px 14px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.95rem;
            }

            .btn-sm {
                padding: 8px 14px;
                font-size: 0.8rem;
            }

            .modal-content {
                padding: 15px;
                margin: 10px;
                max-height: 90vh;
            }

            .main-grid {
                gap: 15px;
            }

            .utility-cards {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .data-table {
                font-size: 0.85rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .app-header {
                padding: 12px;
            }

            .logo-text h1 {
                font-size: 1.3rem;
            }

            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .header-stats {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                width: 100%;
            }

            .header-stats .stat-item {
                padding: 8px;
                background: var(--light-gray);
                border-radius: var(--radius-sm);
                border-left: none !important;
                margin-left: 0 !important;
                padding-left: 8px !important;
            }

            .header-stats .stat-label {
                font-size: 0.7rem;
            }

            .header-stats .stat-value {
                font-size: 0.9rem;
            }

            .balance-container {
                grid-template-columns: 1fr 1fr;
            }

            .balance-card .balance-title {
                gap: 6px;
            }

            .balance-card .balance-icon {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }

            .balance-card .balance-text h3 {
                font-size: 0.85rem;
            }

            .balance-card .balance-thb {
                font-size: 1.2rem;
            }

            .balance-card .edit-btn {
                display: none;
            }

            .rate-value {
                font-size: 1.5rem;
            }

            .btn {
                padding: 10px 16px;
            }

            .transaction-highlight {
                padding: 12px;
            }

            .transaction-highlight h3 {
                font-size: 1.1rem;
            }

            .image-upload-section {
                padding: 12px;
            }

            .upload-icon {
                font-size: 1.5rem;
            }

            .upload-text {
                font-size: 0.8rem;
            }

            .footer-links {
                flex-direction: column;
                align-items: center;
            }

            .exchange-banner {
                display: none;
            }
        }

        /* Touch-friendly improvements */
        @media (pointer: coarse) {
            .btn, .form-control, select {
                min-height: 44px;
            }

            .btn-sm {
                min-height: 36px;
            }

            .balance-card .balance-actions .btn {
                min-height: 36px;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --white: #1e293b;
                --off-white: #0f172a;
                --light-gray: #334155;
                --medium-gray: #475569;
                --border: #475569;
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --text-tertiary: #94a3b8;
                --shadow: rgba(0, 0, 0, 0.3);
            }
            
            body {
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            }
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .container {
                padding: 0;
                max-width: 100%;
            }
            
            .card, .utility-card, .transactions-section {
                box-shadow: none;
                border: 1px solid #000;
                break-inside: avoid;
            }
        }

        /* Custom Animations */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--medium-gray);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: var(--secondary-blue);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: var(--text-primary);
            color: var(--white);
            text-align: center;
            padding: 10px;
            border-radius: var(--radius-md);
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            font-weight: normal;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-primary) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <script>
        // Luxon DateTime Library
        const DateTime = luxon.DateTime;
    </script>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Setup Wizard (Initial Setup) -->
    <div class="setup-wizard" id="setupWizard">
        <div class="wizard-progress">
            <div class="wizard-progress-bar" id="wizardProgress" style="width: 25%"></div>
        </div>
        
        <div class="wizard-content">
            <div class="wizard-step active" id="step1">
                <div style="text-align: center; padding: 40px 20px;">
                    <div class="logo-icon" style="margin: 0 auto 25px auto; width: 80px; height: 80px; font-size: 36px;">
                        <i class="fas fa-book"></i>
                    </div>
                    <h2 style="font-size: 2.2rem; margin-bottom: 15px; color: var(--primary-blue);">
                        Welcome to Hans Financial Note
                    </h2>
                    <p style="color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 30px; line-height: 1.6;">
                        Your advanced personal finance management system with real-time exchange rates and comprehensive tracking.
                    </p>
                    <button class="btn btn-primary" id="startSetupBtn" style="padding: 15px 40px; font-size: 1.1rem;">
                        Begin Setup <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="wizard-step" id="step2">
                <h3 style="color: var(--primary-blue); margin-bottom: 25px;">
                    <i class="fas fa-wallet"></i> Initial Balances Setup
                </h3>
                
                <div class="form-group">
                    <label class="form-label" for="initialBankBalance">
                        <i class="fas fa-university"></i>
                        Initial Bank Balance (THB)
                    </label>
                    <div class="input-with-icon">
                        <input type="number" class="form-control" id="initialBankBalance" placeholder="25000" step="0.01" value="25000">
                        <span class="input-icon">฿</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="initialCashBalance">
                        <i class="fas fa-money-bill"></i>
                        Initial Cash Balance (THB)
                    </label>
                    <div class="input-with-icon">
                        <input type="number" class="form-control" id="initialCashBalance" placeholder="5000" step="0.01" value="5000">
                        <span class="input-icon">฿</span>
                    </div>
                </div>
                
                <div class="wizard-nav">
                    <button class="btn btn-outline" id="prevStep2Btn">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" id="nextStep2Btn">
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="wizard-step" id="step3">
                <h3 style="color: var(--primary-blue); margin-bottom: 25px;">
                    <i class="fas fa-tags"></i> Categories Setup
                </h3>
                
                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                    Add your income and expense categories:
                </p>
                
                <div id="initialCategoriesContainer" style="max-height: 300px; overflow-y: auto; margin-bottom: 25px; background: var(--light-gray); padding: 20px; border-radius: var(--radius-md);">
                    <!-- Categories will be loaded here -->
                </div>
                
                <div class="form-group">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="newCategoryInput" placeholder="New category name" style="flex: 1;">
                        <button type="button" class="btn btn-gold" id="addInitialCategoryBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <div class="wizard-nav">
                    <button class="btn btn-outline" id="prevStep3Btn">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" id="nextStep3Btn">
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="wizard-step" id="step4">
                <h3 style="color: var(--primary-blue); margin-bottom: 25px;">
                    <i class="fas fa-bolt"></i> Utilities Setup
                </h3>
                
                <p style="margin-bottom: 25px; color: var(--text-secondary);">
                    Set up your utility monitoring system:
                </p>
                
                <div class="form-group">
                    <label class="form-label" for="initialElectricityReading">
                        <i class="fas fa-lightbulb"></i>
                        Initial Electricity Reading (kWh)
                    </label>
                    <input type="number" class="form-control" id="initialElectricityReading" placeholder="0" step="0.01" value="0">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="initialWaterReading">
                        <i class="fas fa-tint"></i>
                        Initial Water Reading (units)
                    </label>
                    <input type="number" class="form-control" id="initialWaterReading" placeholder="0" step="0.01" value="0">
                </div>
                
                <div class="wizard-nav">
                    <button class="btn btn-outline" id="prevStep4Btn">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-success" id="finishSetupBtn" style="padding: 12px 30px;">
                        <i class="fas fa-check"></i> Complete Setup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container" id="mainApp" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Hans Financial Note</h1>
                        <div class="subtitle">
                            <span id="currentDateTime">Loading date and time...</span>
                            <span class="badge" id="appStatusBadge" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">
                                <i class="fas fa-circle" style="font-size: 8px;"></i> Online
                            </span>
                        </div>
                    </div>
                </div>

                <div class="header-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Balance</span>
                        <span class="stat-value" id="totalBalanceTHB">฿ 0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Exchange Rate</span>
                        <span class="stat-value" id="headerExchangeRate">1 THB = 460 IDR</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Monthly Budget</span>
                        <span class="stat-value" id="headerMonthlyBudget">฿ 0.00</span>
                    </div>
                    <div class="stat-item" style="border-left: 2px solid var(--border); padding-left: 20px; margin-left: 10px;">
                        <button class="btn btn-sm btn-outline" id="headerSettingsBtn" title="Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" id="headerHelpBtn" title="Help" style="margin-left: 8px;">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Cloud Sync Bar -->
        <div class="cloud-sync-bar not-connected" id="cloudSyncBar">
            <div class="sync-status">
                <i class="fas fa-cloud"></i>
                <div>
                    <strong id="syncAccountName">Not Connected</strong>
                    <div style="font-size: 0.8rem; opacity: 0.9;" id="syncStatusText">Sign in to sync data across devices</div>
                </div>
            </div>
            <div class="sync-actions">
                <button class="btn" id="cloudSignInBtn">
                    <i class="fab fa-google"></i> Sign In with Google
                </button>
            </div>
        </div>

        <!-- NEW TRANSACTION - Main Highlight Section -->
        <div class="transaction-highlight" id="newTransactionSection">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="card-text">
                        <h3>New Transaction</h3>
                        <div class="card-subtitle" id="syncStatus">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            <span>Quick entry for income & expenses</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline" id="quickAddBtn">
                    <i class="fas fa-bolt"></i> Quick Add
                </button>
            </div>

            <form id="transactionForm">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="txDate">
                            <i class="far fa-calendar"></i> Date
                        </label>
                        <input type="date" class="form-control" id="txDate" required>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="txAmount">
                            <i class="fas fa-money-bill"></i> Amount (THB)
                        </label>
                        <div class="input-with-icon">
                            <input type="number" class="form-control" id="txAmount" placeholder="15000" required step="0.01">
                            <span class="input-icon">฿</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="txType">
                            <i class="fas fa-exchange-alt"></i> Type
                        </label>
                        <select class="form-control" id="txType" required>
                            <option value="">Select Type</option>
                            <option value="income">💰 Income</option>
                            <option value="expense">💸 Expense</option>
                            <option value="transfer">🔄 Transfer</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="txDescription">
                            <i class="fas fa-file-invoice-dollar"></i> Description
                        </label>
                        <input type="text" class="form-control" id="txDescription" placeholder="Salary, Groceries, Rent..." required list="descriptionSuggestions">
                        <datalist id="descriptionSuggestions"></datalist>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="txCategory">
                            <i class="fas fa-tag"></i> Category
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control" id="txCategory" required style="flex: 1;">
                                <option value="">Select Category</option>
                            </select>
                            <button type="button" class="btn btn-gold btn-sm" id="addCategoryBtn" title="Add new category">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" for="txPaymentMethod">
                            <i class="fas fa-credit-card"></i> Payment Method
                        </label>
                        <select class="form-control" id="txPaymentMethod" required>
                            <option value="">Select Method</option>
                            <option value="bank">🏦 Bank Transfer</option>
                            <option value="cash">💵 Cash</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label" for="txNotes">
                        <i class="far fa-sticky-note"></i> Additional Notes (Optional)
                    </label>
                    <textarea class="form-control" id="txNotes" rows="2" placeholder="Any additional details..."></textarea>
                </div>

                <!-- Image Upload Section -->
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label">
                        <i class="fas fa-camera"></i> Receipt/Proof (Optional)
                    </label>
                    <div class="image-upload-section" id="imageUploadArea" onclick="document.getElementById('txReceiptImage').click()">
                        <input type="file" id="txReceiptImage" accept="image/*" style="display: none;" onchange="AdvancedFinanceApp.handleImageUpload(event)">
                        <div id="imageUploadPlaceholder">
                            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                            <div class="upload-text">Tap to upload receipt image</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 5px;">Supports JPG, PNG (auto-saves to Google Drive)</div>
                        </div>
                        <div id="imagePreviewContainer" style="display: none;">
                            <img id="receiptPreview" class="image-preview" alt="Receipt preview">
                            <button type="button" class="btn btn-sm btn-danger" style="margin-top: 10px;" onclick="AdvancedFinanceApp.removeUploadedImage(event)">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="idrCalculation" style="display: none; margin-top: 15px;">
                    <div class="calculation-result" style="padding: 15px;">
                        <div class="calc-item">
                            <span class="calc-label">IDR Equivalent</span>
                            <span class="calc-value" id="idrEquivalent">Rp 0</span>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 2;">
                        <i class="fas fa-save"></i> Save Transaction
                    </button>
                    <button type="button" class="btn btn-outline" id="resetFormBtn" style="flex: 1;">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                    <button type="button" class="btn btn-outline" id="recurringBtn" style="flex: 1;">
                        <i class="fas fa-sync"></i> Recurring
                    </button>
                </div>
            </form>
        </div>

        <!-- Exchange Rate Banner (Compact) -->
        <div class="exchange-banner" id="exchangeBanner" style="padding: 15px 20px; margin-bottom: 15px;">
            <div class="exchange-content">
                <div class="rate-info">
                    <div class="rate-icon" style="width: 40px; height: 40px; font-size: 1rem;">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="rate-display">
                        <span class="rate-value" id="currentRate" style="font-size: 1.8rem;">460.00</span>
                        <span class="rate-currency">IDR/THB</span>
                    </div>
                    <div class="rate-details" style="font-size: 0.8rem;">
                        <div class="rate-source">
                            <i class="fas fa-database"></i>
                            <span id="rateSource">ExchangeRate-API</span>
                        </div>
                        <div class="rate-update">
                            <i class="far fa-clock"></i>
                            <span id="rateUpdateTime">Just now</span>
                        </div>
                    </div>
                </div>

                <div class="rate-controls">
                    <button class="btn btn-outline btn-sm" id="manualRateBtn" style="background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3);">
                        <i class="fas fa-edit"></i> Manual
                    </button>
                    <button class="btn btn-sm" id="refreshRateBtn" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Balance Cards (Compact) -->
        <div class="balance-container">
            <!-- Bank Account Card -->
            <div class="balance-card bank">
                <div class="balance-header">
                    <div class="balance-title">
                        <div class="balance-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="balance-text">
                            <h3>Bank Account</h3>
                            <div class="balance-status" id="bankStatus">
                                <i class="fas fa-circle"></i>
                                <span>Connected</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline" id="editBankBalanceBtn">
                        <i class="fas fa-edit"></i> Edit Balance
                    </button>
                </div>
                
                <div class="balance-amount">
                    <div class="balance-thb" id="bankBalanceTHB">
                        <span>฿</span>
                        <span id="bankBalanceValue">0.00</span>
                    </div>
                    <div class="balance-idr" id="bankBalanceIDR">
                        ≈ Rp <span id="bankBalanceIDRValue">0</span>
                    </div>
                </div>
                
                <div class="balance-details">
                    <div class="detail-item">
                        <span class="detail-label">Exchange Rate</span>
                        <span class="detail-value" id="bankExchangeRate">460 IDR/THB</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Transaction</span>
                        <span class="detail-value" id="bankLastTx">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Updated</span>
                        <span class="detail-value" id="bankLastUpdated">-</span>
                    </div>
                </div>
                
                <div class="balance-actions">
                    <button class="btn btn-sm btn-outline" id="bankHistoryBtn">
                        <i class="fas fa-history"></i> History
                    </button>
                    <button class="btn btn-sm btn-outline" id="bankAdjustBtn">
                        <i class="fas fa-adjust"></i> Adjust
                    </button>
                </div>
            </div>

            <!-- Cash Wallet Card -->
            <div class="balance-card cash">
                <div class="balance-header">
                    <div class="balance-title">
                        <div class="balance-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="balance-text">
                            <h3>Cash Wallet</h3>
                            <div class="balance-status" id="cashStatus">
                                <i class="fas fa-circle"></i>
                                <span>Active</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline" id="editCashBalanceBtn">
                        <i class="fas fa-edit"></i> Edit Balance
                    </button>
                </div>
                
                <div class="balance-amount">
                    <div class="balance-thb" id="cashBalanceTHB">
                        <span>฿</span>
                        <span id="cashBalanceValue">0.00</span>
                    </div>
                    <div class="balance-idr" id="cashBalanceIDR">
                        ≈ Rp <span id="cashBalanceIDRValue">0</span>
                    </div>
                </div>
                
                <div class="balance-details">
                    <div class="detail-item">
                        <span class="detail-label">Exchange Rate</span>
                        <span class="detail-value" id="cashExchangeRate">460 IDR/THB</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Transaction</span>
                        <span class="detail-value" id="cashLastTx">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Updated</span>
                        <span class="detail-value" id="cashLastUpdated">-</span>
                    </div>
                </div>
                
                <div class="balance-actions">
                    <button class="btn btn-sm btn-outline" id="cashHistoryBtn">
                        <i class="fas fa-history"></i> History
                    </button>
                    <button class="btn btn-sm btn-outline" id="cashAdjustBtn">
                        <i class="fas fa-adjust"></i> Adjust
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Grid: Budget and Investment -->
        <div class="main-grid">
            <!-- Budget Overview Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="card-text">
                            <h3>Budget Overview</h3>
                            <div class="card-subtitle">
                                <i class="far fa-calendar-alt"></i>
                                <span id="budgetMonth">This Month</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline" id="editBudgetBtn">
                        <i class="fas fa-cog"></i> Configure
                    </button>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Monthly Budget</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary);" id="monthlyBudgetTHB">
                                ฿ 0.00
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Spent This Month</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: var(--danger);" id="monthlySpentTHB">
                                ฿ 0.00
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                            <span>Budget Usage</span>
                            <span id="budgetUsagePercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-good" id="budgetProgressBar" style="width: 0%"></div>
                        </div>
                        <div style="text-align: right; margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);">
                            <span id="budgetStatusText">Within Budget</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-weight: 600; color: var(--text-primary);">Remaining Budget</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--success);" id="monthlyRemainingTHB">
                            ฿ 0.00
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="budgetChart"></canvas>
                </div>

                <!-- Category Budget Breakdown -->
                <div id="categoryBudgetBreakdown" style="margin-top: 25px; display: none;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-list-alt"></i> Category Budget Breakdown
                    </div>
                    <div id="categoryBudgetList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Category budget items will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Investment Dashboard Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-text">
                            <h3>Investment Portfolio</h3>
                            <div class="card-subtitle">
                                <i class="fas fa-percentage"></i>
                                <span>Monthly Projections</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline" id="editInvestmentsBtn">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                
                <div class="investment-allocation" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">Stock Market</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-blue);" id="stockAmountTHB">
                            ฿ 0.00
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-top: 4px;">
                            <span id="stockPercentage">70%</span> • Target: <span id="stockTargetReturn">1.5</span>%/mo
                        </div>
                    </div>
                    
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">Cryptocurrency</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--gold-primary);" id="cryptoAmountTHB">
                            ฿ 0.00
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-top: 4px;">
                            <span id="cryptoPercentage">30%</span> • Target: <span id="cryptoTargetReturn">3.0</span>%/mo
                        </div>
                    </div>
                </div>
                
                <div style="background: var(--off-white); padding: 20px; border-radius: var(--radius-lg); margin-top: 15px;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 15px;">Projected Returns</div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                        <span>Monthly Return</span>
                        <span style="font-weight: 600; color: var(--success);" id="totalProfitTHB">฿ 0.00</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Annual Projection</span>
                        <span style="font-weight: 600; color: var(--text-primary);" id="annualProfitTHB">฿ 0.00</span>
                    </div>
                </div>
                
                <div class="chart-container" style="margin-top: 20px;">
                    <canvas id="investmentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Utility Tracking Section -->
        <div style="background: var(--white); border-radius: var(--radius-xl); padding: 30px; box-shadow: 0 8px 30px var(--shadow); border: 1px solid var(--border); margin-bottom: 30px;">
            <div class="card-header" style="margin-bottom: 30px;">
                <div class="card-title">
                    <div class="card-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="card-text">
                        <h3>Utility Tracking</h3>
                        <div class="card-subtitle">
                            <i class="far fa-clock"></i>
                            <span>Last Updated: <span id="utilityLastUpdated">-</span></span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline" id="utilitySettingsBtn">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">
                <!-- Electricity Card -->
                <div class="utility-card">
                    <div class="utility-header">
                        <div class="utility-title">
                            <div class="utility-icon electricity">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div class="utility-text">
                                <h4>Electricity</h4>
                                <div class="utility-rate">
                                    Rate: <span id="electricityRateDisplay">8</span> THB/kWh
                                </div>
                            </div>
                        </div>
                        <div class="utility-last-update">
                            <i class="far fa-calendar"></i>
                            <span id="electricityLastUpdate">-</span>
                        </div>
                    </div>
                    
                    <div class="reading-grid">
                        <div class="reading-card">
                            <div class="reading-label">
                                <i class="fas fa-history"></i>
                                Last Reading
                            </div>
                            <div class="reading-value" id="electricityLastReading">
                                0 kWh
                            </div>
                            <div class="reading-date" id="electricityLastDate">
                                Date: -
                            </div>
                        </div>
                        
                        <div class="reading-card">
                            <div class="reading-label">
                                <i class="fas fa-edit"></i>
                                Current Reading
                            </div>
                            <input type="number" class="current-reading-input" id="electricityCurrentReading" placeholder="Enter reading" step="0.01">
                            <div class="reading-date">
                                <input type="date" id="electricityCurrentDate" style="border: none; background: transparent; color: var(--text-tertiary); width: 100%; margin-top: 8px; font-size: 0.85rem;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary btn-block" id="calculateElectricityBtn">
                            <i class="fas fa-calculator"></i> Calculate Consumption
                        </button>
                    </div>
                    
                    <div class="calculation-result" id="electricityCalcResult" style="display: none;">
                        <div class="calc-grid">
                            <div class="calc-item">
                                <div class="calc-label">Total Consumption</div>
                                <div class="calc-value" id="electricityTotal">0 kWh</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-label">Days Between</div>
                                <div class="calc-value" id="electricityDays">0 days</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-label">Daily Average</div>
                                <div class="calc-value" id="electricityAverage">0 kWh/day</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-label">Total Cost</div>
                                <div class="calc-value" id="electricityCostTHB">฿ 0.00</div>
                            </div>
                        </div>
                        
                        <div class="warning-alert" id="electricityWarning" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <div style="font-weight: 600;">High Consumption Alert</div>
                                <div style="font-size: 0.9rem; margin-top: 4px;">Daily average exceeds threshold of <span id="electricityThreshold">3</span> kWh/day</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-success" style="flex: 1;" id="saveElectricityBtn">
                                <i class="fas fa-save"></i> Save Reading
                            </button>
                            <button class="btn btn-outline" style="flex: 1;" id="cancelElectricityBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Water Card -->
                <div class="utility-card">
                    <div class="utility-header">
                        <div class="utility-title">
                            <div class="utility-icon water">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div class="utility-text">
                                <h4>Water</h4>
                                <div class="utility-rate">
                                    Rate: <span id="waterRateDisplay">20</span> THB/unit
                                </div>
                            </div>
                        </div>
                        <div class="utility-last-update">
                            <i class="far fa-calendar"></i>
                            <span id="waterLastUpdate">-</span>
                        </div>
                    </div>
                    
                    <div class="reading-grid">
                        <div class="reading-card">
                            <div class="reading-label">
                                <i class="fas fa-history"></i>
                                Last Reading
                            </div>
                            <div class="reading-value" id="waterLastReading">
                                0 units
                            </div>
                            <div class="reading-date" id="waterLastDate">
                                Date: -
                            </div>
                        </div>
                        
                        <div class="reading-card">
                            <div class="reading-label">
                                <i class="fas fa-edit"></i>
                                Current Reading
                            </div>
                            <input type="number" class="current-reading-input" id="waterCurrentReading" placeholder="Enter reading" step="0.01">
                            <div class="reading-date">
                                <input type="date" id="waterCurrentDate" style="border: none; background: transparent; color: var(--text-tertiary); width: 100%; margin-top: 8px; font-size: 0.85rem;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary btn-block" id="calculateWaterBtn">
                            <i class="fas fa-calculator"></i> Calculate Consumption
                        </button>
                    </div>
                    
                    <div class="calculation-result" id="waterCalcResult" style="display: none;">
                        <div class="calc-grid">
                            <div class="calc-item">
                                <div class="calc-label">Total Consumption</div>
                                <div class="calc-value" id="waterTotal">0 units</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-label">Days Between</div>
                                <div class="calc-value" id="waterDays">0 days</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-label">Daily Average</div>
                                <div class="calc-value" id="waterAverage">0 units/day</div>
                            </div>
                            <div class="calc-item">
                                <div class="calc-label">Total Cost</div>
                                <div class="calc-value" id="waterCostTHB">฿ 0.00</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-success" style="flex: 1;" id="saveWaterBtn">
                                <i class="fas fa-save"></i> Save Reading
                            </button>
                            <button class="btn btn-outline" style="flex: 1;" id="cancelWaterBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: flex-end;">
                <button class="btn btn-outline" id="addPastReadingBtn">
                    <i class="fas fa-plus-circle"></i> Add Past Reading
                </button>
                <button class="btn btn-outline" id="utilityHistoryBtn">
                    <i class="fas fa-history"></i> View History
                </button>
                <button class="btn btn-outline" id="utilityExportBtn">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
        </div>

        <!-- Transactions History -->
        <div style="background: var(--white); border-radius: var(--radius-xl); padding: 30px; box-shadow: 0 8px 30px var(--shadow); border: 1px solid var(--border); margin-bottom: 30px;">
            <div class="card-header" style="margin-bottom: 25px;">
                <div class="card-title">
                    <div class="card-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="card-text">
                        <h3>Transaction History</h3>
                        <div class="card-subtitle" id="transactionStats">
                            Total: <span id="totalTransactions">0</span> transactions
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sm btn-danger" id="bulkDeleteBtn" style="display: none;">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                    <button class="btn btn-sm btn-outline" id="exportBtn">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
            </div>
            
            <div class="table-filters">
                <button class="btn btn-sm active" data-filter="all">All</button>
                <button class="btn btn-sm" data-filter="income">Income</button>
                <button class="btn btn-sm" data-filter="expense">Expenses</button>
                <button class="btn btn-sm" data-filter="transfer">Transfers</button>
                <select class="form-control" id="categoryFilter" style="flex: 1; max-width: 200px;">
                    <option value="">All Categories</option>
                </select>
                <input type="date" class="form-control" id="startDateFilter" placeholder="From" style="max-width: 150px;">
                <input type="date" class="form-control" id="endDateFilter" placeholder="To" style="max-width: 150px;">
                <button class="btn btn-sm btn-primary" id="applyFiltersBtn">
                    <i class="fas fa-filter"></i> Apply
                </button>
                <button class="btn btn-sm btn-outline" id="clearFiltersBtn">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="selectAllCheckbox">
                            </th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount (THB)</th>
                            <th>Amount (IDR)</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Payment</th>
                            <th style="width: 80px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        <tr id="emptyStateRow">
                            <td colspan="9" style="text-align: center; padding: 40px 20px;">
                                <div style="color: var(--text-secondary);">
                                    <i class="fas fa-file-invoice-dollar" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                    <h3 style="margin-bottom: 10px;">No transactions yet</h3>
                                    <p>Start by adding your first transaction</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                    Showing <span id="shownCount">0</span> of <span id="totalCount">0</span> transactions
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-sm btn-outline" id="prevPageBtn" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span style="margin: 0 10px;">Page <span id="currentPage">1</span></span>
                    <button class="btn btn-sm btn-outline" id="nextPageBtn" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <p>© <span id="currentYear">2024</span> Hans Financial Note | Advanced Personal Finance Management System</p>
            <div class="footer-links">
                <button class="btn btn-sm btn-outline" id="settingsBtn">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="btn btn-sm btn-outline" id="backupBtn">
                    <i class="fas fa-database"></i> Backup Data
                </button>
                <button class="btn btn-sm btn-outline" id="restoreBtn">
                    <i class="fas fa-undo"></i> Restore Data
                </button>
                <button class="btn btn-sm btn-outline" id="helpBtn">
                    <i class="fas fa-question-circle"></i> Help
                </button>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    
    <!-- Edit Balance Modal -->
    <div class="modal" id="editBalanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="editBalanceTitle">
                    <i class="fas fa-edit"></i> Edit Balance
                </h3>
                <button class="close-modal" id="closeEditBalanceModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label" id="editBalanceLabel">
                    <i class="fas fa-money-bill"></i>
                    New Balance (THB)
                </label>
                <div class="input-with-icon">
                    <input type="number" class="form-control" id="editBalanceAmount" step="0.01">
                    <span class="input-icon">฿</span>
                </div>
                <div style="margin-top: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                    IDR Equivalent: <span id="editBalanceIDR">Rp 0</span>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="far fa-sticky-note"></i>
                    Adjustment Reason (Optional)
                </label>
                <input type="text" class="form-control" id="editBalanceReason" placeholder="e.g., Bank reconciliation, Cash adjustment">
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-outline" id="cancelEditBalanceBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="saveEditBalanceBtn" style="flex: 1;">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Category Management Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-tags"></i> Manage Categories
                </h3>
                <button class="close-modal" id="closeCategoryModal">&times;</button>
            </div>

            <!-- Category Type Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 10px;">
                <button class="btn btn-sm active" id="incomeCategoryTab" data-type="income" style="flex: 1;">
                    <i class="fas fa-arrow-up"></i> Income
                </button>
                <button class="btn btn-sm" id="expenseCategoryTab" data-type="expense" style="flex: 1;">
                    <i class="fas fa-arrow-down"></i> Expense
                </button>
                <button class="btn btn-sm" id="transferCategoryTab" data-type="transfer" style="flex: 1;">
                    <i class="fas fa-exchange-alt"></i> Transfer
                </button>
            </div>

            <div id="categoryListContainer" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Categories will be loaded here -->
            </div>

            <div class="form-group">
                <label class="form-label" for="newCategoryName">
                    <i class="fas fa-plus"></i>
                    Add New Category
                </label>
                <div style="display: flex; gap: 10px;">
                    <select class="form-control" id="newCategoryType" style="width: 130px;">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                        <option value="transfer">Transfer</option>
                    </select>
                    <input type="text" class="form-control" id="newCategoryName" placeholder="Enter category name" style="flex: 1;">
                    <button class="btn btn-primary" id="saveNewCategoryBtn">
                        Add
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Exchange Rate Modal -->
    <div class="modal" id="manualRateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i> Set Manual Exchange Rate
                </h3>
                <button class="close-modal" id="closeManualRateModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="manualRateValue">
                    <i class="fas fa-money-bill-wave"></i>
                    THB to IDR Rate
                </label>
                <div class="input-with-icon">
                    <input type="number" class="form-control" id="manualRateValue" step="0.01">
                    <span class="input-icon">IDR/THB</span>
                </div>
                <div style="margin-top: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                    1 THB = <span id="manualRatePreview">0</span> IDR
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-outline" id="cancelManualRateBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="saveManualRateBtn" style="flex: 1;">
                    Set Rate
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-cog"></i> Application Settings
                </h3>
                <button class="close-modal" id="closeSettingsModal">&times;</button>
            </div>
            
            <div class="settings-grid">
                <div class="setting-group">
                    <div class="setting-title">
                        <i class="fas fa-exchange-alt"></i>
                        Exchange Rate Settings
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="exchangeRateSource">
                            Data Source
                        </label>
                        <select class="form-control" id="exchangeRateSource">
                            <option value="exchangerateapi">ExchangeRate-API (Recommended)</option>
                            <option value="openexchangerates">Open Exchange Rates</option>
                            <option value="google">Google Finance</option>
                            <option value="manual">Manual Entry</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="apiKeyContainer" style="display: none;">
                        <label class="form-label" for="apiKey">
                            API Key
                        </label>
                        <input type="password" class="form-control" id="apiKey" placeholder="Enter your API key">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="refreshInterval">
                            Auto-refresh Interval
                        </label>
                        <select class="form-control" id="refreshInterval">
                            <option value="30000">30 seconds</option>
                            <option value="60000">1 minute</option>
                            <option value="300000">5 minutes</option>
                            <option value="900000">15 minutes</option>
                            <option value="1800000">30 minutes</option>
                            <option value="3600000">1 hour</option>
                        </select>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-title">
                        <i class="fas fa-bolt"></i>
                        Utility Settings
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="electricityRate">
                            Electricity Rate (THB/kWh)
                        </label>
                        <input type="number" class="form-control" id="electricityRate" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="waterRate">
                            Water Rate (THB/unit)
                        </label>
                        <input type="number" class="form-control" id="waterRate" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="electricityThreshold">
                            Electricity Warning Threshold (kWh/day)
                        </label>
                        <input type="number" class="form-control" id="electricityThreshold" step="0.01">
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-title">
                        <i class="fas fa-sync-alt"></i>
                        Google Sheets Sync
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="googleSheetsUrl">
                            Web App URL
                        </label>
                        <input type="text" class="form-control" id="googleSheetsUrl" placeholder="https://script.google.com/...">
                        <div style="margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);">
                            Leave empty to disable sync
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="sync-status" id="sheetsConnectionStatus" style="margin-top: 10px;">
                            <i class="fas fa-circle"></i>
                            <span>Status: Not Connected</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" id="testSheetsConnectionBtn" style="flex: 1;">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                        <button class="btn btn-outline" id="syncNowBtn" style="flex: 1;">
                            <i class="fas fa-sync"></i> Sync Now
                        </button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-title">
                        <i class="fas fa-palette"></i>
                        Appearance
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="themeSelect">
                            Theme
                        </label>
                        <select class="form-control" id="themeSelect">
                            <option value="auto">Auto (Follow System)</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="currencyFormat">
                            Currency Format
                        </label>
                        <select class="form-control" id="currencyFormat">
                            <option value="thousands">1,234.56</option>
                            <option value="spaces">1 234.56</option>
                            <option value="dots">1.234,56</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-outline" id="cancelSettingsBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="saveSettingsBtn" style="flex: 1;">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button class="btn btn-danger btn-block" id="resetAppBtn">
                    <i class="fas fa-trash"></i> Reset All Data
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-question-circle"></i> Help & Documentation
                </h3>
                <button class="close-modal" id="closeHelpModal">&times;</button>
            </div>

            <div style="max-height: 500px; overflow-y: auto;">
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--primary-blue); margin-bottom: 15px;">Quick Start Guide</h4>
                    <ol style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                        <li>Complete the initial setup wizard to configure your accounts</li>
                        <li>Add your first transaction using the "New Transaction" form</li>
                        <li>Monitor your budget and investments in real-time</li>
                        <li>Track utility consumption using the monitoring cards</li>
                        <li>Configure settings for exchange rates and Google Sheets sync</li>
                    </ol>
                </div>

                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--primary-blue); margin-bottom: 15px;">Features</h4>
                    <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                        <li><strong>Real-time Exchange Rates</strong>: Automatic updates from reliable sources</li>
                        <li><strong>Utility Monitoring</strong>: Track electricity and water consumption</li>
                        <li><strong>Budget Management</strong>: Set and monitor monthly budgets</li>
                        <li><strong>Investment Tracking</strong>: Portfolio management with projections</li>
                        <li><strong>Google Sheets Sync</strong>: Automatic backup to Google Sheets</li>
                        <li><strong>Data Export</strong>: Export to CSV for external analysis</li>
                    </ul>
                </div>

                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--primary-blue); margin-bottom: 15px;">Keyboard Shortcuts</h4>
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; font-size: 0.9rem;">
                            <div style="font-weight: 600;">Ctrl + N</div>
                            <div>New Transaction</div>
                            <div style="font-weight: 600;">Ctrl + S</div>
                            <div>Save/Sync</div>
                            <div style="font-weight: 600;">Ctrl + E</div>
                            <div>Export Data</div>
                            <div style="font-weight: 600;">Ctrl + ,</div>
                            <div>Open Settings</div>
                            <div style="font-weight: 600;">Ctrl + H</div>
                            <div>Show Help</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--primary-blue); margin-bottom: 15px;">Support</h4>
                    <p style="color: var(--text-secondary);">
                        For issues or feature requests, please ensure:
                    </p>
                    <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                        <li>You have an active internet connection for exchange rates</li>
                        <li>Your browser has localStorage enabled</li>
                        <li>JavaScript is enabled in your browser</li>
                        <li>You're using a modern browser (Chrome, Firefox, Safari, Edge)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Configuration Modal -->
    <div class="modal" id="budgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-chart-pie"></i> Budget Configuration
                </h3>
                <button class="close-modal" id="closeBudgetModal">&times;</button>
            </div>

            <div style="max-height: 500px; overflow-y: auto;">
                <div class="form-group">
                    <label class="form-label" for="budgetAnnualIncome">
                        <i class="fas fa-money-bill-wave"></i>
                        Annual Income (THB)
                    </label>
                    <div class="input-with-icon">
                        <input type="number" class="form-control" id="budgetAnnualIncome" step="0.01" placeholder="600000">
                        <span class="input-icon">฿</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                        Monthly: ฿<span id="budgetMonthlyIncomePreview">0</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="budgetMonthlyLimit">
                        <i class="fas fa-wallet"></i>
                        Monthly Budget Limit (THB)
                    </label>
                    <div class="input-with-icon">
                        <input type="number" class="form-control" id="budgetMonthlyLimit" step="0.01" placeholder="50000">
                        <span class="input-icon">฿</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                        IDR Equivalent: Rp <span id="budgetMonthlyLimitIDR">0</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="budgetSavingsGoal">
                        <i class="fas fa-piggy-bank"></i>
                        Monthly Savings Goal (THB)
                    </label>
                    <div class="input-with-icon">
                        <input type="number" class="form-control" id="budgetSavingsGoal" step="0.01" placeholder="10000">
                        <span class="input-icon">฿</span>
                    </div>
                </div>

                <div style="margin-top: 25px; margin-bottom: 15px;">
                    <h4 style="color: var(--primary-blue); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-tags"></i> Category Budgets
                    </h4>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px;">
                        Set spending limits for each category (optional)
                    </p>
                </div>

                <div id="categoryBudgetsContainer" style="max-height: 250px; overflow-y: auto; background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                    <!-- Category budgets will be loaded here -->
                </div>

                <div style="margin-top: 20px; padding: 15px; background: var(--off-white); border-radius: var(--radius-md); border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: var(--text-secondary);">Total Category Budgets</span>
                        <span style="font-weight: 600;" id="totalCategoryBudgets">฿ 0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Unallocated Budget</span>
                        <span style="font-weight: 600; color: var(--success);" id="unallocatedBudget">฿ 0.00</span>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-outline" id="cancelBudgetBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="saveBudgetBtn" style="flex: 1;">
                    <i class="fas fa-save"></i> Save Budget
                </button>
            </div>
        </div>
    </div>

    <!-- Investment Configuration Modal -->
    <div class="modal" id="investmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-chart-line"></i> Investment Configuration
                </h3>
                <button class="close-modal" id="closeInvestmentModal">&times;</button>
            </div>

            <div style="max-height: 500px; overflow-y: auto;">
                <div class="form-group">
                    <label class="form-label" for="investmentAllocation">
                        <i class="fas fa-percentage"></i>
                        Investment Allocation (% of Annual Income)
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="range" id="investmentAllocationSlider" min="0" max="100" value="20" style="flex: 1;">
                        <input type="number" class="form-control" id="investmentAllocation" style="width: 80px;" min="0" max="100" value="20">
                        <span>%</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                        Annual Investment: ฿<span id="annualInvestmentPreview">0</span>
                    </div>
                </div>

                <div style="margin-top: 25px; margin-bottom: 15px;">
                    <h4 style="color: var(--primary-blue); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-pie"></i> Portfolio Allocation
                    </h4>
                </div>

                <div class="form-group">
                    <label class="form-label" for="stockAllocation">
                        <i class="fas fa-chart-bar"></i>
                        Stock Market Allocation
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <input type="range" id="stockAllocationSlider" min="0" max="100" value="70" style="flex: 1;">
                        <input type="number" class="form-control" id="stockAllocation" style="width: 80px;" min="0" max="100" value="70">
                        <span>%</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 0.9rem; color: var(--text-secondary); min-width: 80px;">Amount:</span>
                        <input type="number" class="form-control" id="stockAmountInput" style="flex: 1;" placeholder="Enter amount" step="0.01">
                        <span>฿</span>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.85rem; color: var(--text-tertiary);">
                        Calculated: ฿<span id="stockAmountPreview">0</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="cryptoAllocation">
                        <i class="fab fa-bitcoin"></i>
                        Cryptocurrency Allocation
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <input type="range" id="cryptoAllocationSlider" min="0" max="100" value="30" style="flex: 1;">
                        <input type="number" class="form-control" id="cryptoAllocation" style="width: 80px;" min="0" max="100" value="30">
                        <span>%</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 0.9rem; color: var(--text-secondary); min-width: 80px;">Amount:</span>
                        <input type="number" class="form-control" id="cryptoAmountInput" style="flex: 1;" placeholder="Enter amount" step="0.01">
                        <span>฿</span>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.85rem; color: var(--text-tertiary);">
                        Calculated: ฿<span id="cryptoAmountPreview">0</span>
                    </div>
                </div>

                <div id="allocationWarning" class="warning-alert" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <div style="font-weight: 600;">Allocation Warning</div>
                        <div style="font-size: 0.9rem; margin-top: 4px;">Stock + Crypto allocation must equal 100%</div>
                    </div>
                </div>

                <div style="margin-top: 25px; margin-bottom: 15px;">
                    <h4 style="color: var(--primary-blue); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-line"></i> Expected Returns
                    </h4>
                </div>

                <div class="form-group">
                    <label class="form-label" for="stockReturn">
                        <i class="fas fa-percentage"></i>
                        Stock Expected Monthly Return (%)
                    </label>
                    <input type="number" class="form-control" id="stockReturn" step="0.1" value="1.5" min="0" max="50">
                </div>

                <div class="form-group">
                    <label class="form-label" for="cryptoReturn">
                        <i class="fas fa-percentage"></i>
                        Crypto Expected Monthly Return (%)
                    </label>
                    <input type="number" class="form-control" id="cryptoReturn" step="0.1" value="3.0" min="0" max="100">
                </div>

                <div style="margin-top: 20px; padding: 15px; background: var(--off-white); border-radius: var(--radius-md); border: 1px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 15px; color: var(--primary-blue);">Projected Returns</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: var(--text-secondary);">Monthly Return</span>
                        <span style="font-weight: 600; color: var(--success);" id="projectedMonthlyReturn">฿ 0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Annual Return</span>
                        <span style="font-weight: 600;" id="projectedAnnualReturn">฿ 0.00</span>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-outline" id="cancelInvestmentBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="saveInvestmentBtn" style="flex: 1;">
                    <i class="fas fa-save"></i> Save Investment
                </button>
            </div>
        </div>
    </div>

    <!-- Recurring Transactions Modal -->
    <div class="modal" id="recurringModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-redo"></i> Recurring Transactions
                </h3>
                <button class="close-modal" id="closeRecurringModal">&times;</button>
            </div>

            <div style="margin-bottom: 25px;">
                <h4 style="color: var(--primary-blue); margin-bottom: 15px;">Add New Recurring Transaction</h4>

                <div class="form-group">
                    <label class="form-label" for="recurringDescription">
                        <i class="fas fa-file-invoice-dollar"></i>
                        Description
                    </label>
                    <input type="text" class="form-control" id="recurringDescription" placeholder="Monthly Rent, Salary, etc.">
                </div>

                <div class="form-group">
                    <label class="form-label" for="recurringAmount">
                        <i class="fas fa-money-bill"></i>
                        Amount (THB)
                    </label>
                    <div class="input-with-icon">
                        <input type="number" class="form-control" id="recurringAmount" step="0.01">
                        <span class="input-icon">฿</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label" for="recurringType">
                            <i class="fas fa-exchange-alt"></i>
                            Type
                        </label>
                        <select class="form-control" id="recurringType">
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recurringCategory">
                            <i class="fas fa-tag"></i>
                            Category
                        </label>
                        <select class="form-control" id="recurringCategory">
                            <!-- Categories will be loaded -->
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label" for="recurringFrequency">
                            <i class="fas fa-calendar-alt"></i>
                            Frequency
                        </label>
                        <select class="form-control" id="recurringFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recurringDay">
                            <i class="fas fa-calendar-day"></i>
                            Day of Month
                        </label>
                        <input type="number" class="form-control" id="recurringDay" min="1" max="31" value="1">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="recurringPaymentMethod">
                        <i class="fas fa-credit-card"></i>
                        Payment Method
                    </label>
                    <select class="form-control" id="recurringPaymentMethod">
                        <option value="bank">Bank Transfer</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-toggle-on"></i>
                        Status
                    </label>
                    <label class="toggle">
                        <input type="checkbox" id="recurringActive" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span style="margin-left: 10px; color: var(--text-secondary);">Active</span>
                </div>

                <button class="btn btn-success btn-block" id="addRecurringBtn">
                    <i class="fas fa-plus"></i> Add Recurring Transaction
                </button>
            </div>

            <div style="border-top: 2px solid var(--border); padding-top: 25px;">
                <h4 style="color: var(--primary-blue); margin-bottom: 15px;">Existing Recurring Transactions</h4>

                <div id="recurringListContainer" style="max-height: 300px; overflow-y: auto;">
                    <!-- Recurring transactions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Utility History Modal -->
    <div class="modal" id="utilityHistoryModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-history"></i> Utility Consumption History
                </h3>
                <button class="close-modal" id="closeUtilityHistoryModal">&times;</button>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <button class="btn btn-sm active" id="electricityHistoryTab" data-tab="electricity">
                    <i class="fas fa-lightbulb"></i> Electricity
                </button>
                <button class="btn btn-sm" id="waterHistoryTab" data-tab="water">
                    <i class="fas fa-tint"></i> Water
                </button>
            </div>

            <div id="electricityHistoryContent">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Total Consumption</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="electricityTotalConsumption">0 kWh</div>
                    </div>
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Total Cost</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="electricityTotalCost">฿ 0.00</div>
                    </div>
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Average Daily</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="electricityAvgDaily">0 kWh</div>
                    </div>
                </div>

                <div class="table-container" style="max-height: 350px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reading</th>
                                <th>Consumption</th>
                                <th>Days</th>
                                <th>Daily Avg</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody id="electricityHistoryBody">
                            <!-- History will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="waterHistoryContent" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Total Consumption</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="waterTotalConsumption">0 units</div>
                    </div>
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Total Cost</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="waterTotalCost">฿ 0.00</div>
                    </div>
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Average Daily</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="waterAvgDaily">0 units</div>
                    </div>
                </div>

                <div class="table-container" style="max-height: 350px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reading</th>
                                <th>Consumption</th>
                                <th>Days</th>
                                <th>Daily Avg</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody id="waterHistoryBody">
                            <!-- History will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal" id="editTransactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i> Edit Transaction
                </h3>
                <button class="close-modal" id="closeEditTransactionModal">&times;</button>
            </div>

            <form id="editTransactionForm">
                <input type="hidden" id="editTxId">

                <div class="form-group">
                    <label class="form-label" for="editTxDate">
                        <i class="far fa-calendar"></i>
                        Date
                    </label>
                    <input type="date" class="form-control" id="editTxDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTxDescription">
                        <i class="fas fa-file-invoice-dollar"></i>
                        Description
                    </label>
                    <input type="text" class="form-control" id="editTxDescription" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTxAmount">
                        <i class="fas fa-money-bill"></i>
                        Amount (THB)
                    </label>
                    <div class="input-with-icon">
                        <input type="number" class="form-control" id="editTxAmount" required step="0.01">
                        <span class="input-icon">฿</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTxType">
                        <i class="fas fa-exchange-alt"></i>
                        Transaction Type
                    </label>
                    <select class="form-control" id="editTxType" required>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                        <option value="transfer">Transfer</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTxCategory">
                        <i class="fas fa-tag"></i>
                        Category
                    </label>
                    <select class="form-control" id="editTxCategory" required>
                        <!-- Categories will be loaded -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTxPaymentMethod">
                        <i class="fas fa-credit-card"></i>
                        Payment Method
                    </label>
                    <select class="form-control" id="editTxPaymentMethod" required>
                        <option value="bank">Bank Transfer</option>
                        <option value="cash">Cash</option>
                        <option value="bank_to_cash">Bank → Cash (Withdrawal)</option>
                        <option value="cash_to_bank">Cash → Bank (Deposit)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTxNotes">
                        <i class="far fa-sticky-note"></i>
                        Additional Notes
                    </label>
                    <textarea class="form-control" id="editTxNotes" rows="2"></textarea>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn btn-outline" id="cancelEditTransactionBtn" style="flex: 1;">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account History Modal -->
    <div class="modal" id="accountHistoryModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="accountHistoryTitle">
                    <i class="fas fa-history"></i> Account History
                </h3>
                <button class="close-modal" id="closeAccountHistoryModal">&times;</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Current Balance</div>
                    <div style="font-size: 1.5rem; font-weight: 700;" id="historyCurrentBalance">฿ 0.00</div>
                </div>
                <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Total Income</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="historyTotalIncome">฿ 0.00</div>
                </div>
                <div style="background: var(--light-gray); padding: 15px; border-radius: var(--radius-md);">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Total Expenses</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);" id="historyTotalExpenses">฿ 0.00</div>
                </div>
            </div>

            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Balance After</th>
                        </tr>
                    </thead>
                    <tbody id="accountHistoryBody">
                        <!-- History will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Past Reading Modal -->
    <div class="modal" id="pastReadingModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Add Past Reading
                </h3>
                <button class="close-modal" id="closePastReadingModal">&times;</button>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Utility Type</label>
                <select class="form-control" id="pastReadingType">
                    <option value="electricity">Electricity (kWh)</option>
                    <option value="water">Water (units)</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Reading Value</label>
                <input type="number" class="form-control" id="pastReadingValue" placeholder="Enter meter reading" step="0.01">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Reading Date</label>
                <input type="date" class="form-control" id="pastReadingDate">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Notes (Optional)</label>
                <textarea class="form-control" id="pastReadingNotes" rows="2" placeholder="Add any notes about this reading"></textarea>
            </div>

            <div class="info-alert" style="margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i>
                <div>This allows you to add historical meter readings. The reading will be inserted in chronological order and used for consumption calculations.</div>
            </div>

            <div style="display: flex; gap: 15px;">
                <button class="btn btn-primary" style="flex: 1;" id="savePastReadingBtn">
                    <i class="fas fa-save"></i> Save Reading
                </button>
                <button class="btn btn-outline" style="flex: 1;" id="cancelPastReadingBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // Advanced Finance Application
        const AdvancedFinanceApp = {
            // Configuration
            config: {
                appName: 'Hans Financial Note',
                version: '3.0.0',
                buildDate: '2024-01-01',
                currencies: {
                    primary: 'THB',
                    display: 'IDR',
                    symbols: {
                        THB: '฿',
                        IDR: 'Rp'
                    }
                },
                exchangeRate: {
                    current: 460.00,
                    lastUpdated: null,
                    source: 'exchangerateapi',
                    apiKey: '',
                    autoRefresh: true,
                    refreshInterval: 300000,
                    providers: {
                        exchangerateapi: 'https://api.exchangerate-api.com/v4/latest/THB',
                        openexchangerates: 'https://openexchangerates.org/api/latest.json',
                        google: 'https://www.google.com/finance/quote/THB-IDR'
                    }
                },
                utilities: {
                    electricity: {
                        rate: 8.00,
                        threshold: 3.00
                    },
                    water: {
                        rate: 20.00
                    }
                },
                googleSheets: {
                    enabled: false,
                    webAppUrl: '',
                    syncInterval: 60000,
                    lastSync: null
                },
                appearance: {
                    theme: 'auto',
                    currencyFormat: 'thousands',
                    animations: true
                },
                data: {
                    autoBackup: true,
                    backupInterval: 3600000,
                    encryption: false
                }
            },

            // State Management
            state: {
                isInitialized: false,
                setupComplete: false,
                currentStep: 1,
                totalSteps: 4,
                activeFilters: {
                    type: 'all',
                    category: '',
                    startDate: '',
                    endDate: ''
                },
                pagination: {
                    currentPage: 1,
                    pageSize: 10,
                    totalItems: 0
                },
                loading: {
                    exchangeRate: false,
                    sheetsSync: false,
                    dataLoad: false
                }
            },

            // Storage Keys
            storageKeys: {
                transactions: 'hans_finance_transactions_v3',
                categories: 'hans_finance_categories_v3',
                budget: 'hans_finance_budget_v3',
                investments: 'hans_finance_investments_v3',
                utilities: 'hans_finance_utilities_v3',
                balances: 'hans_finance_balances_v3',
                settings: 'hans_finance_settings_v3',
                setupComplete: 'hans_finance_setup_complete_v3',
                exchangeRates: 'hans_finance_exchange_rates_v3',
                utilityHistory: 'hans_finance_utility_history_v3'
            },

            // Chart Instances
            charts: {
                budget: null,
                investment: null,
                spending: null,
                income: null
            },

            // Initialize Application
            async init() {
                try {
                    // Load settings first
                    await this.loadSettings();
                    
                    // Check if setup is needed
                    await this.checkSetup();
                    
                    // Initialize date and time
                    this.initializeDateTime();
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Initialize components
                    this.initializeComponents();
                    
                    // Start background services
                    this.startBackgroundServices();
                    
                    this.state.isInitialized = true;
                    
                    this.showToast('Application initialized successfully!', 'success');
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showToast('Failed to initialize application', 'error');
                }
            },

            // Initialize date and time
            initializeDateTime() {
                // Update current date and time
                this.updateDateTime();
                
                // Update every second
                setInterval(() => {
                    this.updateDateTime();
                }, 1000);
                
                // Update current year in footer
                document.getElementById('currentYear').textContent = DateTime.now().year;
                
                // Set today's date in form inputs
                const today = DateTime.now().toISODate();
                document.getElementById('txDate').value = today;
                document.getElementById('electricityCurrentDate').value = today;
                document.getElementById('waterCurrentDate').value = today;
            },

            // Update date and time display
            updateDateTime() {
                const now = DateTime.now();
                const dateTimeStr = now.toLocaleString(DateTime.DATETIME_FULL_WITH_SECONDS);
                document.getElementById('currentDateTime').textContent = dateTimeStr;
            },

            // Check setup status
            async checkSetup() {
                const setupComplete = localStorage.getItem(this.storageKeys.setupComplete);
                const hasSettings = localStorage.getItem(this.storageKeys.settings);
                
                if (setupComplete === 'true' && hasSettings) {
                    this.state.setupComplete = true;
                    document.getElementById('setupWizard').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Load all data
                    await this.loadAllData();
                    
                    // Update all displays
                    this.updateAllDisplays();
                    
                    // Fetch real-time exchange rate
                    await this.fetchExchangeRate();
                    
                } else {
                    this.state.setupComplete = false;
                    document.getElementById('setupWizard').style.display = 'block';
                    document.getElementById('mainApp').style.display = 'none';
                    
                    // Initialize setup wizard
                    this.initializeSetupWizard();
                }
            },

            // Initialize setup wizard
            initializeSetupWizard() {
                // Load default categories
                this.loadDefaultCategories();
                
                // Setup wizard event listeners
                document.getElementById('startSetupBtn').onclick = () => this.showWizardStep(2);
                document.getElementById('prevStep2Btn').onclick = () => this.showWizardStep(1);
                document.getElementById('nextStep2Btn').onclick = () => this.showWizardStep(3);
                document.getElementById('prevStep3Btn').onclick = () => this.showWizardStep(2);
                document.getElementById('nextStep3Btn').onclick = () => this.showWizardStep(4);
                document.getElementById('prevStep4Btn').onclick = () => this.showWizardStep(3);
                document.getElementById('finishSetupBtn').onclick = () => this.completeSetup();
                document.getElementById('addInitialCategoryBtn').onclick = () => this.addInitialCategory();
            },

            // Load default categories
            loadDefaultCategories() {
                const defaultCategories = [
                    'Salary',
                    'Freelance',
                    'Investment Income',
                    'Food & Dining',
                    'Transportation',
                    'Housing',
                    'Utilities',
                    'Entertainment',
                    'Healthcare',
                    'Education',
                    'Shopping',
                    'Travel',
                    'Gifts',
                    'Other Income',
                    'Other Expense'
                ];
                
                const container = document.getElementById('initialCategoriesContainer');
                container.innerHTML = '';
                
                defaultCategories.forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'config-item';
                    categoryDiv.innerHTML = `
                        <span>${category}</span>
                        <button type="button" class="btn btn-danger btn-sm remove-category-btn" data-category="${category}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(categoryDiv);
                });
                
                // Add event listeners for remove buttons
                container.addEventListener('click', (e) => {
                    if (e.target.closest('.remove-category-btn')) {
                        e.target.closest('.config-item').remove();
                    }
                });
            },

            // Show wizard step
            showWizardStep(stepNumber) {
                this.state.currentStep = stepNumber;
                
                // Hide all steps
                document.querySelectorAll('.wizard-step').forEach(step => {
                    step.classList.remove('active');
                });
                
                // Show selected step
                document.getElementById(`step${stepNumber}`).classList.add('active');
                
                // Update progress bar
                const progress = (stepNumber / this.state.totalSteps) * 100;
                document.getElementById('wizardProgress').style.width = `${progress}%`;
            },

            // Add initial category
            addInitialCategory() {
                const input = document.getElementById('newCategoryInput');
                const categoryName = input.value.trim();
                
                if (categoryName) {
                    const container = document.getElementById('initialCategoriesContainer');
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'config-item';
                    categoryDiv.innerHTML = `
                        <span>${categoryName}</span>
                        <button type="button" class="btn btn-danger btn-sm remove-category-btn" data-category="${categoryName}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(categoryDiv);
                    input.value = '';
                    input.focus();
                }
            },

            // Complete setup
            async completeSetup() {
                try {
                    // Save initial balances
                    const initialBalances = {
                        bank: parseFloat(document.getElementById('initialBankBalance').value) || 0,
                        cash: parseFloat(document.getElementById('initialCashBalance').value) || 0,
                        lastUpdated: DateTime.now().toISO()
                    };
                    await this.saveData(this.storageKeys.balances, initialBalances);
                    
                    // Save categories
                    const categoryElements = document.querySelectorAll('#initialCategoriesContainer .config-item span');
                    const categories = Array.from(categoryElements).map(el => el.textContent);
                    await this.saveData(this.storageKeys.categories, categories);
                    
                    // Save budget configuration
                    const budgetConfig = {
                        annualIncome: 600000,
                        monthlyBudget: 50000,
                        categoryBudgets: [],
                        lastUpdated: DateTime.now().toISO()
                    };
                    await this.saveData(this.storageKeys.budget, budgetConfig);
                    
                    // Save initial utility readings
                    const utilities = {
                        electricity: {
                            currentReading: parseFloat(document.getElementById('initialElectricityReading').value) || 0,
                            lastReading: null,
                            lastUpdate: DateTime.now().toISO(),
                            history: [],
                            rate: this.config.utilities.electricity.rate,
                            threshold: this.config.utilities.electricity.threshold
                        },
                        water: {
                            currentReading: parseFloat(document.getElementById('initialWaterReading').value) || 0,
                            lastReading: null,
                            lastUpdate: DateTime.now().toISO(),
                            history: [],
                            rate: this.config.utilities.water.rate
                        }
                    };
                    await this.saveData(this.storageKeys.utilities, utilities);
                    
                    // Initialize investments
                    const investmentConfig = {
                        allocationPercentage: 20,
                        stockPercentage: 70,
                        cryptoPercentage: 30,
                        stockReturn: 1.5,
                        cryptoReturn: 3.0,
                        actualReturns: [],
                        lastUpdated: DateTime.now().toISO()
                    };
                    await this.saveData(this.storageKeys.investments, investmentConfig);
                    
                    // Mark setup as complete
                    await this.saveData(this.storageKeys.setupComplete, true);
                    
                    // Show main app
                    document.getElementById('setupWizard').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Load all data
                    await this.loadAllData();
                    
                    // Fetch real-time exchange rate
                    await this.fetchExchangeRate();
                    
                    this.showToast('Setup completed successfully!', 'success');
                    
                } catch (error) {
                    console.error('Setup error:', error);
                    this.showToast('Error during setup. Please try again.', 'error');
                }
            },

            // Load all data
            async loadAllData() {
                try {
                    // Load transactions
                    await this.loadTransactions();
                    
                    // Load categories
                    await this.loadCategories();
                    
                    // Load budget
                    await this.loadBudget();
                    
                    // Load investments
                    await this.loadInvestments();
                    
                    // Load utilities
                    await this.loadUtilities();
                    
                    // Load balances
                    await this.loadBalances();
                    
                    // Update all displays
                    this.updateAllDisplays();
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Error loading data', 'error');
                }
            },

            // Initialize components
            initializeComponents() {
                // Initialize charts
                this.initializeCharts();
                
                // Initialize date inputs
                this.initializeDateInputs();
                
                // Initialize category dropdowns
                this.updateCategoryDropdowns();
            },

            // Initialize charts
            initializeCharts() {
                // Budget chart
                const budgetCtx = document.getElementById('budgetChart')?.getContext('2d');
                if (budgetCtx) {
                    this.charts.budget = new Chart(budgetCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Spent', 'Remaining'],
                            datasets: [{
                                data: [0, 100],
                                backgroundColor: [this.getColor('danger'), this.getColor('success')],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            return `${context.label}: ฿${context.raw}`;
                                        }
                                    }
                                },
                                datalabels: {
                                    color: '#fff',
                                    font: {
                                        weight: 'bold',
                                        size: 14
                                    },
                                    formatter: (value, context) => {
                                        const data = context.chart.data.datasets[0].data;
                                        const total = data.reduce((a, b) => a + b, 0);
                                        if (total === 0 || value === 0) return '';
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return percentage + '%';
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                }
                
                // Investment chart
                const investmentCtx = document.getElementById('investmentChart')?.getContext('2d');
                if (investmentCtx) {
                    this.charts.investment = new Chart(investmentCtx, {
                        type: 'pie',
                        data: {
                            labels: ['Stock Market', 'Cryptocurrency'],
                            datasets: [{
                                data: [70, 30],
                                backgroundColor: [this.getColor('primary'), this.getColor('warning')],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                datalabels: {
                                    color: '#fff',
                                    font: {
                                        weight: 'bold',
                                        size: 14
                                    },
                                    formatter: (value, context) => {
                                        const data = context.chart.data.datasets[0].data;
                                        const total = data.reduce((a, b) => a + b, 0);
                                        if (total === 0 || value === 0) return '';
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return percentage + '%';
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                }
            },

            // Get color by type
            getColor(type) {
                const colors = {
                    primary: 'rgba(59, 130, 246, 0.8)',
                    success: 'rgba(16, 185, 129, 0.8)',
                    warning: 'rgba(245, 158, 11, 0.8)',
                    danger: 'rgba(239, 68, 68, 0.8)',
                    info: 'rgba(59, 130, 246, 0.8)'
                };
                return colors[type] || colors.primary;
            },

            // Initialize date inputs
            initializeDateInputs() {
                const today = DateTime.now().toISODate();
                const oneMonthAgo = DateTime.now().minus({ months: 1 }).toISODate();
                
                document.getElementById('txDate').value = today;
                document.getElementById('electricityCurrentDate').value = today;
                document.getElementById('waterCurrentDate').value = today;
                document.getElementById('startDateFilter').value = oneMonthAgo;
                document.getElementById('endDateFilter').value = today;
            },

            // Setup event listeners
            setupEventListeners() {
                // Cloud sync controls
                document.getElementById('cloudSignInBtn').onclick = () => this.handleCloudSignIn();

                // Header controls
                document.getElementById('refreshRateBtn').onclick = () => this.fetchExchangeRate();
                document.getElementById('manualRateBtn').onclick = () => this.showManualRateModal();
                
                // Balance controls
                document.getElementById('editBankBalanceBtn').onclick = () => this.showEditBalanceModal('bank');
                document.getElementById('editCashBalanceBtn').onclick = () => this.showEditBalanceModal('cash');
                document.getElementById('bankAdjustBtn').onclick = () => this.showAdjustmentModal('bank');
                document.getElementById('cashAdjustBtn').onclick = () => this.showAdjustmentModal('cash');
                document.getElementById('bankHistoryBtn').onclick = () => this.showAccountHistoryModal('bank');
                document.getElementById('cashHistoryBtn').onclick = () => this.showAccountHistoryModal('cash');

                // Transaction form
                document.getElementById('transactionForm').onsubmit = (e) => {
                    e.preventDefault();
                    this.saveTransaction();
                };
                document.getElementById('resetFormBtn').onclick = () => this.resetTransactionForm();
                document.getElementById('txAmount').oninput = () => this.updateIDRCalculation();
                document.getElementById('txType').onchange = (e) => this.handleTransactionTypeChange(e.target.value);
                document.getElementById('addCategoryBtn').onclick = () => this.showCategoryModal();
                document.getElementById('quickAddBtn').onclick = () => this.quickAddTransaction();
                document.getElementById('recurringBtn').onclick = () => this.showRecurringModal();

                // Budget and investments
                document.getElementById('editBudgetBtn').onclick = () => this.showBudgetModal();
                document.getElementById('editInvestmentsBtn').onclick = () => this.showInvestmentModal();
                
                // Utility controls
                document.getElementById('calculateElectricityBtn').onclick = () => this.calculateElectricity();
                document.getElementById('saveElectricityBtn').onclick = () => this.saveElectricityReading();
                document.getElementById('cancelElectricityBtn').onclick = () => this.cancelElectricityCalculation();
                document.getElementById('calculateWaterBtn').onclick = () => this.calculateWater();
                document.getElementById('saveWaterBtn').onclick = () => this.saveWaterReading();
                document.getElementById('cancelWaterBtn').onclick = () => this.cancelWaterCalculation();
                document.getElementById('utilitySettingsBtn').onclick = () => this.showUtilitySettings();
                document.getElementById('utilityHistoryBtn').onclick = () => this.showUtilityHistory();
                document.getElementById('utilityExportBtn').onclick = () => this.exportUtilityData();
                document.getElementById('addPastReadingBtn').onclick = () => this.showPastReadingModal();
                
                // Transaction filters
                document.querySelectorAll('.table-filters .btn[data-filter]').forEach(btn => {
                    btn.onclick = (e) => this.filterTransactions(e.target.dataset.filter);
                });
                document.getElementById('applyFiltersBtn').onclick = () => this.applyAdvancedFilters();
                document.getElementById('clearFiltersBtn').onclick = () => this.clearFilters();
                document.getElementById('exportBtn').onclick = () => this.exportToCSV();
                document.getElementById('bulkDeleteBtn').onclick = () => this.deleteSelectedTransactions();
                
                // Settings and help
                document.getElementById('settingsBtn').onclick = () => this.showSettingsModal();
                document.getElementById('helpBtn').onclick = () => this.showHelpModal();

                // Header settings and help buttons
                document.getElementById('headerSettingsBtn').onclick = () => this.showSettingsModal();
                document.getElementById('headerHelpBtn').onclick = () => this.showHelpModal();
                document.getElementById('backupBtn').onclick = () => this.backupData();
                document.getElementById('restoreBtn').onclick = () => this.restoreData();
                document.getElementById('resetAppBtn').onclick = () => this.resetAppData();
                
                // Modals
                this.initializeModals();
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
                
                // Window events
                window.addEventListener('beforeunload', () => this.autoSave());
                window.addEventListener('online', () => this.handleConnectionChange(true));
                window.addEventListener('offline', () => this.handleConnectionChange(false));
            },

            // Initialize modals
            initializeModals() {
                // Edit balance modal
                document.getElementById('closeEditBalanceModal').onclick = () => this.hideModal('editBalanceModal');
                document.getElementById('cancelEditBalanceBtn').onclick = () => this.hideModal('editBalanceModal');
                document.getElementById('saveEditBalanceBtn').onclick = () => this.saveEditedBalance();
                document.getElementById('editBalanceAmount').oninput = () => this.updateEditBalanceIDR();
                
                // Category modal
                document.getElementById('closeCategoryModal').onclick = () => this.hideModal('categoryModal');
                document.getElementById('saveNewCategoryBtn').onclick = () => this.saveNewCategory();
                document.getElementById('incomeCategoryTab').onclick = () => this.switchCategoryTab('income');
                document.getElementById('expenseCategoryTab').onclick = () => this.switchCategoryTab('expense');
                document.getElementById('transferCategoryTab').onclick = () => this.switchCategoryTab('transfer');
                
                // Manual rate modal
                document.getElementById('closeManualRateModal').onclick = () => this.hideModal('manualRateModal');
                document.getElementById('cancelManualRateBtn').onclick = () => this.hideModal('manualRateModal');
                document.getElementById('saveManualRateBtn').onclick = () => this.saveManualRate();
                document.getElementById('manualRateValue').oninput = () => this.updateManualRatePreview();
                
                // Settings modal
                document.getElementById('closeSettingsModal').onclick = () => this.hideModal('settingsModal');
                document.getElementById('cancelSettingsBtn').onclick = () => this.hideModal('settingsModal');
                document.getElementById('saveSettingsBtn').onclick = () => this.saveSettings();
                document.getElementById('exchangeRateSource').onchange = (e) => this.handleExchangeSourceChange(e.target.value);
                document.getElementById('testSheetsConnectionBtn').onclick = () => this.testSheetsConnection();
                document.getElementById('syncNowBtn').onclick = () => this.syncWithGoogleSheets();
                
                // Help modal
                document.getElementById('closeHelpModal').onclick = () => this.hideModal('helpModal');

                // Budget modal
                document.getElementById('closeBudgetModal').onclick = () => this.hideModal('budgetModal');
                document.getElementById('cancelBudgetBtn').onclick = () => this.hideModal('budgetModal');
                document.getElementById('saveBudgetBtn').onclick = () => this.saveBudgetConfig();
                document.getElementById('budgetAnnualIncome').oninput = () => this.updateBudgetPreview();
                document.getElementById('budgetMonthlyLimit').oninput = () => this.updateBudgetPreview();

                // Investment modal
                document.getElementById('closeInvestmentModal').onclick = () => this.hideModal('investmentModal');
                document.getElementById('cancelInvestmentBtn').onclick = () => this.hideModal('investmentModal');
                document.getElementById('saveInvestmentBtn').onclick = () => this.saveInvestmentConfig();
                document.getElementById('investmentAllocationSlider').oninput = (e) => this.syncInvestmentSlider('allocation', e.target.value);
                document.getElementById('investmentAllocation').oninput = (e) => this.syncInvestmentInput('allocation', e.target.value);
                document.getElementById('stockAllocationSlider').oninput = (e) => this.syncInvestmentSlider('stock', e.target.value);
                document.getElementById('stockAllocation').oninput = (e) => this.syncInvestmentInput('stock', e.target.value);
                document.getElementById('cryptoAllocationSlider').oninput = (e) => this.syncInvestmentSlider('crypto', e.target.value);
                document.getElementById('cryptoAllocation').oninput = (e) => this.syncInvestmentInput('crypto', e.target.value);
                document.getElementById('stockAmountInput').oninput = (e) => this.syncInvestmentAmount('stock', e.target.value);
                document.getElementById('cryptoAmountInput').oninput = (e) => this.syncInvestmentAmount('crypto', e.target.value);
                document.getElementById('stockReturn').oninput = () => this.updateInvestmentPreview();
                document.getElementById('cryptoReturn').oninput = () => this.updateInvestmentPreview();

                // Recurring modal
                document.getElementById('closeRecurringModal').onclick = () => this.hideModal('recurringModal');
                document.getElementById('addRecurringBtn').onclick = () => this.addRecurringTransaction();

                // Utility history modal
                document.getElementById('closeUtilityHistoryModal').onclick = () => this.hideModal('utilityHistoryModal');
                document.getElementById('electricityHistoryTab').onclick = () => this.switchUtilityHistoryTab('electricity');
                document.getElementById('waterHistoryTab').onclick = () => this.switchUtilityHistoryTab('water');

                // Edit transaction modal
                document.getElementById('closeEditTransactionModal').onclick = () => this.hideModal('editTransactionModal');
                document.getElementById('cancelEditTransactionBtn').onclick = () => this.hideModal('editTransactionModal');
                document.getElementById('editTransactionForm').onsubmit = (e) => {
                    e.preventDefault();
                    this.saveEditedTransaction();
                };

                // Account history modal
                document.getElementById('closeAccountHistoryModal').onclick = () => this.hideModal('accountHistoryModal');

                // Past reading modal
                document.getElementById('closePastReadingModal').onclick = () => this.hideModal('pastReadingModal');
                document.getElementById('cancelPastReadingBtn').onclick = () => this.hideModal('pastReadingModal');
                document.getElementById('savePastReadingBtn').onclick = () => this.savePastReading();

                // Close modals on outside click
                window.onclick = (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                };
            },

            // Handle exchange source change
            handleExchangeSourceChange(source) {
                const apiKeyContainer = document.getElementById('apiKeyContainer');
                apiKeyContainer.style.display = source === 'openexchangerates' ? 'block' : 'none';
            },

            // Show modal
            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            },

            // Hide modal
            hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            },

            // Load settings
            async loadSettings() {
                try {
                    const savedSettings = await this.loadData(this.storageKeys.settings);
                    if (savedSettings) {
                        this.config = { ...this.config, ...savedSettings };
                    }
                    
                    // Apply theme
                    this.applyTheme();
                    
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            },

            // Save settings
            async saveSettings() {
                try {
                    // Update config from form
                    this.config.exchangeRate.source = document.getElementById('exchangeRateSource').value;
                    this.config.exchangeRate.apiKey = document.getElementById('apiKey').value || '';
                    this.config.exchangeRate.refreshInterval = parseInt(document.getElementById('refreshInterval').value);
                    
                    this.config.utilities.electricity.rate = parseFloat(document.getElementById('electricityRate').value) || 8;
                    this.config.utilities.water.rate = parseFloat(document.getElementById('waterRate').value) || 20;
                    this.config.utilities.electricity.threshold = parseFloat(document.getElementById('electricityThreshold').value) || 3;
                    
                    this.config.googleSheets.webAppUrl = document.getElementById('googleSheetsUrl').value;
                    this.config.googleSheets.enabled = !!this.config.googleSheets.webAppUrl;
                    
                    this.config.appearance.theme = document.getElementById('themeSelect').value;
                    this.config.appearance.currencyFormat = document.getElementById('currencyFormat').value;
                    
                    // Save to storage
                    await this.saveData(this.storageKeys.settings, this.config);
                    
                    // Apply theme
                    this.applyTheme();
                    
                    // Update displays
                    this.updateExchangeRateDisplay();
                    this.updateUtilityDisplay();
                    this.updateSheetsStatus();
                    
                    // Hide modal
                    this.hideModal('settingsModal');
                    
                    this.showToast('Settings saved successfully', 'success');
                    
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showToast('Error saving settings', 'error');
                }
            },

            // Apply theme
            applyTheme() {
                const theme = this.config.appearance.theme;
                
                if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            },

            // Fetch exchange rate from API
            async fetchExchangeRate() {
                if (this.state.loading.exchangeRate) return;
                
                try {
                    this.state.loading.exchangeRate = true;
                    
                    let newRate = this.config.exchangeRate.current;
                    let source = 'Manual';
                    
                    // Try to fetch from API based on source
                    if (this.config.exchangeRate.source !== 'manual') {
                        try {
                            switch (this.config.exchangeRate.source) {
                                case 'exchangerateapi':
                                    const response1 = await fetch('https://api.exchangerate-api.com/v4/latest/THB');
                                    if (response1.ok) {
                                        const data = await response1.json();
                                        newRate = data.rates.IDR;
                                        source = 'ExchangeRate-API';
                                    }
                                    break;
                                    
                                case 'openexchangerates':
                                    if (this.config.exchangeRate.apiKey) {
                                        const response2 = await fetch(
                                            `https://openexchangerates.org/api/latest.json?app_id=${this.config.exchangeRate.apiKey}&base=THB&symbols=IDR`
                                        );
                                        if (response2.ok) {
                                            const data = await response2.json();
                                            newRate = data.rates.IDR;
                                            source = 'Open Exchange Rates';
                                        }
                                    }
                                    break;
                                    
                                case 'google':
                                    // Note: Google Finance API requires special handling
                                    // For now, we'll use a fallback
                                    newRate = await this.fetchGoogleFinanceRate();
                                    source = 'Google Finance';
                                    break;
                            }
                        } catch (apiError) {
                            console.warn('API fetch failed, using cached rate:', apiError);
                        }
                    }
                    
                    // Update config
                    this.config.exchangeRate.current = newRate;
                    this.config.exchangeRate.lastUpdated = DateTime.now().toISO();
                    
                    // Save to storage
                    await this.saveData(this.storageKeys.settings, this.config);
                    
                    // Update display
                    this.updateExchangeRateDisplay(source);
                    
                    // Update all currency displays
                    this.updateAllCurrencyDisplays();
                    
                    this.showToast('Exchange rate updated', 'success');
                    
                } catch (error) {
                    console.error('Error fetching exchange rate:', error);
                    this.showToast('Failed to update exchange rate', 'error');
                } finally {
                    this.state.loading.exchangeRate = false;
                }
            },

            // Fetch rate from Google Finance (simulated)
            async fetchGoogleFinanceRate() {
                // This is a simulated response since Google Finance API is not directly accessible
                // In production, you would need a proper API or proxy
                return this.config.exchangeRate.current * (0.99 + Math.random() * 0.02); // Simulate small fluctuation
            },

            // Update exchange rate display
            updateExchangeRateDisplay(source = null) {
                const rate = this.config.exchangeRate.current;
                const lastUpdated = this.config.exchangeRate.lastUpdated 
                    ? DateTime.fromISO(this.config.exchangeRate.lastUpdated).toRelative()
                    : 'Never';
                
                document.getElementById('currentRate').textContent = rate.toFixed(2);
                document.getElementById('rateSource').textContent = source || this.config.exchangeRate.source;
                document.getElementById('rateUpdateTime').textContent = lastUpdated;
                document.getElementById('headerExchangeRate').textContent = `1 THB = ${rate.toFixed(2)} IDR`;
            },

            // Update all currency displays
            updateAllCurrencyDisplays() {
                this.updateBalances();
                this.updateBudgetDisplay();
                this.updateInvestmentDisplay();
                this.updateTransactionList();
            },

            // Show manual rate modal
            showManualRateModal() {
                const modal = document.getElementById('manualRateModal');
                document.getElementById('manualRateValue').value = this.config.exchangeRate.current;
                this.updateManualRatePreview();
                modal.style.display = 'flex';
            },

            // Update manual rate preview
            updateManualRatePreview() {
                const rate = parseFloat(document.getElementById('manualRateValue').value) || 0;
                document.getElementById('manualRatePreview').textContent = rate.toFixed(2);
            },

            // Save manual rate
            saveManualRate() {
                const newRate = parseFloat(document.getElementById('manualRateValue').value);
                
                if (newRate > 0) {
                    this.config.exchangeRate.current = newRate;
                    this.config.exchangeRate.source = 'manual';
                    this.config.exchangeRate.lastUpdated = DateTime.now().toISO();
                    
                    this.updateExchangeRateDisplay('Manual');
                    this.updateAllCurrencyDisplays();
                    
                    this.saveData(this.storageKeys.settings, this.config);
                    this.hideModal('manualRateModal');
                    
                    this.showToast('Manual exchange rate set', 'success');
                } else {
                    this.showToast('Please enter a valid rate', 'error');
                }
            },

            // Start background services
            startBackgroundServices() {
                // Auto-refresh exchange rate
                if (this.config.exchangeRate.autoRefresh) {
                    setInterval(() => {
                        if (navigator.onLine) {
                            this.fetchExchangeRate();
                        }
                    }, this.config.exchangeRate.refreshInterval);
                }
                
                // Auto-save
                setInterval(() => {
                    this.autoSave();
                }, 30000); // Every 30 seconds
                
                // Google Sheets sync
                if (this.config.googleSheets.enabled) {
                    setInterval(() => {
                        if (navigator.onLine) {
                            this.syncWithGoogleSheets();
                        }
                    }, this.config.googleSheets.syncInterval);
                }
                
                // Data backup
                if (this.config.data.autoBackup) {
                    setInterval(() => {
                        this.autoBackup();
                    }, this.config.data.backupInterval);
                }
            },

            // Handle connection change
            handleConnectionChange(isOnline) {
                const statusBadge = document.getElementById('appStatusBadge');
                
                if (isOnline) {
                    statusBadge.innerHTML = '<i class="fas fa-circle" style="font-size: 8px;"></i> Online';
                    statusBadge.style.background = 'rgba(16, 185, 129, 0.1)';
                    statusBadge.style.color = 'var(--success)';
                    
                    // Fetch exchange rate when coming online
                    this.fetchExchangeRate();
                    
                } else {
                    statusBadge.innerHTML = '<i class="fas fa-circle" style="font-size: 8px;"></i> Offline';
                    statusBadge.style.background = 'rgba(245, 158, 11, 0.1)';
                    statusBadge.style.color = 'var(--warning)';
                }
            },

            // Auto-save
            async autoSave() {
                try {
                    // Save current state
                    await this.saveData(this.storageKeys.transactions, this.state.transactions || []);
                    await this.saveData(this.storageKeys.balances, this.state.balances || {});
                    
                    // Update last saved timestamp
                    document.getElementById('appStatusBadge').innerHTML = 
                        '<i class="fas fa-circle" style="font-size: 8px;"></i> Saved';
                    
                    setTimeout(() => {
                        if (navigator.onLine) {
                            document.getElementById('appStatusBadge').innerHTML = 
                                '<i class="fas fa-circle" style="font-size: 8px;"></i> Online';
                        }
                    }, 2000);
                    
                } catch (error) {
                    console.error('Auto-save error:', error);
                }
            },

            // Auto-backup
            async autoBackup() {
                try {
                    const backup = {
                        timestamp: DateTime.now().toISO(),
                        data: {
                            transactions: await this.loadData(this.storageKeys.transactions),
                            categories: await this.loadData(this.storageKeys.categories),
                            budget: await this.loadData(this.storageKeys.budget),
                            investments: await this.loadData(this.storageKeys.investments),
                            utilities: await this.loadData(this.storageKeys.utilities),
                            balances: await this.loadData(this.storageKeys.balances),
                            settings: this.config
                        }
                    };
                    
                    // Store backup with timestamp
                    const backupKey = `backup_${DateTime.now().toFormat('yyyy-MM-dd_HH-mm')}`;
                    await this.saveData(backupKey, backup);
                    
                    // Keep only last 7 backups
                    await this.cleanupOldBackups();
                    
                } catch (error) {
                    console.error('Auto-backup error:', error);
                }
            },

            // Cleanup old backups
            async cleanupOldBackups() {
                try {
                    const keys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
                    if (keys.length > 7) {
                        // Sort by timestamp and remove oldest
                        keys.sort();
                        const keysToRemove = keys.slice(0, keys.length - 7);
                        keysToRemove.forEach(key => localStorage.removeItem(key));
                    }
                } catch (error) {
                    console.error('Backup cleanup error:', error);
                }
            },

            // Load data from storage
            async loadData(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error(`Error loading ${key}:`, error);
                    return null;
                }
            },

            // Save data to storage
            async saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error(`Error saving ${key}:`, error);
                    this.showToast('Error saving data', 'error');
                    return false;
                }
            },

            // Update all displays
            updateAllDisplays() {
                this.updateBalances();
                this.updateTransactionList();
                this.updateBudgetDisplay();
                this.updateInvestmentDisplay();
                this.updateUtilityDisplay();
                this.updateCategoryDropdowns();
                this.updateDescriptionSuggestions();
                this.updateSheetsStatus();
            },

            // Update balances
            async updateBalances() {
                const balances = await this.loadData(this.storageKeys.balances) || { bank: 0, cash: 0 };
                const rate = this.config.exchangeRate.current;
                
                // Format currency
                const formatCurrency = (amount, currency = 'THB') => {
                    return new Intl.NumberFormat('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(amount);
                };
                
                // Bank balance
                document.getElementById('bankBalanceValue').textContent = formatCurrency(balances.bank);
                document.getElementById('bankBalanceIDRValue').textContent = formatCurrency(balances.bank * rate);
                document.getElementById('bankExchangeRate').textContent = `${rate.toFixed(2)} IDR/THB`;
                document.getElementById('bankLastUpdated').textContent = balances.lastUpdated 
                    ? DateTime.fromISO(balances.lastUpdated).toRelative()
                    : '-';
                
                // Cash balance
                document.getElementById('cashBalanceValue').textContent = formatCurrency(balances.cash);
                document.getElementById('cashBalanceIDRValue').textContent = formatCurrency(balances.cash * rate);
                document.getElementById('cashExchangeRate').textContent = `${rate.toFixed(2)} IDR/THB`;
                document.getElementById('cashLastUpdated').textContent = balances.lastUpdated 
                    ? DateTime.fromISO(balances.lastUpdated).toRelative()
                    : '-';
                
                // Total balance
                const totalBalance = balances.bank + balances.cash;
                document.getElementById('totalBalanceTHB').textContent = `฿ ${formatCurrency(totalBalance)}`;
                
                // Update edit balance modal preview
                this.updateEditBalanceIDR();
            },

            // Update edit balance IDR preview
            updateEditBalanceIDR() {
                const amount = parseFloat(document.getElementById('editBalanceAmount').value) || 0;
                const idrAmount = amount * this.config.exchangeRate.current;
                document.getElementById('editBalanceIDR').textContent = 
                    `Rp ${new Intl.NumberFormat('id-ID').format(idrAmount.toFixed(2))}`;
            },

            // Show edit balance modal
            async showEditBalanceModal(type) {
                const balances = await this.loadData(this.storageKeys.balances) || { bank: 0, cash: 0 };
                const currentBalance = balances[type] || 0;
                
                document.getElementById('editBalanceTitle').innerHTML = 
                    `<i class="fas fa-edit"></i> Edit ${type === 'bank' ? 'Bank' : 'Cash'} Balance`;
                document.getElementById('editBalanceLabel').innerHTML = 
                    `<i class="fas fa-money-bill"></i> New ${type === 'bank' ? 'Bank' : 'Cash'} Balance (THB)`;
                document.getElementById('editBalanceAmount').value = currentBalance;
                document.getElementById('editBalanceModal').dataset.balanceType = type;
                
                this.updateEditBalanceIDR();
                this.showModal('editBalanceModal');
            },

            // Save edited balance
            async saveEditedBalance() {
                const type = document.getElementById('editBalanceModal').dataset.balanceType;
                const newBalance = parseFloat(document.getElementById('editBalanceAmount').value);
                const reason = document.getElementById('editBalanceReason').value.trim();
                
                if (isNaN(newBalance)) {
                    this.showToast('Please enter a valid amount', 'error');
                    return;
                }
                
                try {
                    const balances = await this.loadData(this.storageKeys.balances) || { bank: 0, cash: 0 };
                    const oldBalance = balances[type] || 0;
                    
                    // Update balance
                    balances[type] = newBalance;
                    balances.lastUpdated = DateTime.now().toISO();
                    
                    // Save adjustment record
                    const adjustments = await this.loadData('balance_adjustments') || [];
                    adjustments.unshift({
                        type: type,
                        oldBalance: oldBalance,
                        newBalance: newBalance,
                        difference: newBalance - oldBalance,
                        reason: reason,
                        timestamp: DateTime.now().toISO(),
                        exchangeRate: this.config.exchangeRate.current
                    });
                    
                    // Keep only last 50 adjustments
                    if (adjustments.length > 50) {
                        adjustments.length = 50;
                    }
                    
                    // Save data
                    await this.saveData(this.storageKeys.balances, balances);
                    await this.saveData('balance_adjustments', adjustments);
                    
                    // Update displays
                    this.updateBalances();
                    this.hideModal('editBalanceModal');
                    
                    this.showToast(`${type === 'bank' ? 'Bank' : 'Cash'} balance updated`, 'success');
                    
                } catch (error) {
                    console.error('Error saving balance:', error);
                    this.showToast('Error updating balance', 'error');
                }
            },

            // Show adjustment modal
            async showAdjustmentModal(type) {
                // Similar to edit balance but with more detailed options
                this.showEditBalanceModal(type);
            },

            // Load transactions
            async loadTransactions() {
                this.state.transactions = await this.loadData(this.storageKeys.transactions) || [];
                return this.state.transactions;
            },

            // Save transaction
            async saveTransaction() {
                try {
                    // Get form values
                    const date = document.getElementById('txDate').value;
                    const description = document.getElementById('txDescription').value.trim();
                    const amount = parseFloat(document.getElementById('txAmount').value);
                    const type = document.getElementById('txType').value;
                    const category = document.getElementById('txCategory').value;
                    const paymentMethod = document.getElementById('txPaymentMethod').value;
                    const notes = document.getElementById('txNotes').value.trim();
                    
                    // Validation
                    if (!date || !description || isNaN(amount) || !type || !category || !paymentMethod) {
                        this.showToast('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    // Get current balances
                    const balances = await this.loadData(this.storageKeys.balances) || { bank: 0, cash: 0 };
                    
                    // Create transaction object
                    let transaction = {
                        id: `tx_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        date: date,
                        description: description,
                        amountTHB: amount,
                        amountIDR: amount * this.config.exchangeRate.current,
                        type: type,
                        category: category,
                        paymentMethod: paymentMethod,
                        notes: notes,
                        exchangeRate: this.config.exchangeRate.current,
                        timestamp: DateTime.now().toISO(),
                        bankBalanceBefore: balances.bank,
                        cashBalanceBefore: balances.cash,
                        synced: false,
                        recurring: false
                    };

                    // Handle image upload if present
                    transaction = await this.saveTransactionWithImage(transaction);
                    
                    // Update balances based on transaction
                    this.updateBalancesFromTransaction(transaction, balances);
                    
                    // Update transaction with new balances
                    transaction.bankBalanceAfter = balances.bank;
                    transaction.cashBalanceAfter = balances.cash;
                    
                    // Save transaction
                    const transactions = await this.loadTransactions();
                    transactions.unshift(transaction);
                    await this.saveData(this.storageKeys.transactions, transactions);
                    
                    // Save updated balances
                    balances.lastUpdated = DateTime.now().toISO();
                    await this.saveData(this.storageKeys.balances, balances);
                    
                    // Reset form
                    this.resetTransactionForm();
                    
                    // Update displays
                    this.updateAllDisplays();
                    
                    // Sync with Google Sheets if enabled
                    if (this.config.googleSheets.enabled) {
                        await this.syncTransactionWithSheets(transaction);
                    }

                    // Sync to cloud if connected
                    if (this.state.currentUser) {
                        await this.syncDataToCloud();
                    }

                    this.showToast('Transaction saved successfully', 'success');
                    
                } catch (error) {
                    console.error('Error saving transaction:', error);
                    this.showToast('Error saving transaction', 'error');
                }
            },

            // Update balances from transaction
            updateBalancesFromTransaction(transaction, balances) {
                const amount = transaction.amountTHB;
                
                switch (transaction.type) {
                    case 'income':
                        if (transaction.paymentMethod === 'bank') {
                            balances.bank += amount;
                        } else if (transaction.paymentMethod === 'cash') {
                            balances.cash += amount;
                        }
                        break;
                        
                    case 'expense':
                        if (transaction.paymentMethod === 'bank') {
                            balances.bank -= amount;
                        } else if (transaction.paymentMethod === 'cash') {
                            balances.cash -= amount;
                        }
                        break;
                        
                    case 'transfer':
                        if (transaction.paymentMethod === 'bank_to_cash') {
                            balances.bank -= amount;
                            balances.cash += amount;
                        } else if (transaction.paymentMethod === 'cash_to_bank') {
                            balances.cash -= amount;
                            balances.bank += amount;
                        }
                        break;
                }
            },

            // Quick add transaction
            quickAddTransaction() {
                // Pre-fill form with common values
                document.getElementById('txDescription').value = 'Quick Transaction';
                document.getElementById('txAmount').value = '';
                document.getElementById('txAmount').focus();
                this.showToast('Enter amount and complete form', 'info');
            },

            // Reset transaction form
            resetTransactionForm() {
                document.getElementById('transactionForm').reset();
                document.getElementById('txDate').value = DateTime.now().toISODate();
                document.getElementById('idrCalculation').style.display = 'none';
                this.updateCategoryDropdowns();
            },

            // Update IDR calculation
            updateIDRCalculation() {
                const amount = parseFloat(document.getElementById('txAmount').value);
                if (!isNaN(amount) && amount !== 0) {
                    const idrAmount = amount * this.config.exchangeRate.current;
                    document.getElementById('idrEquivalent').textContent = 
                        `Rp ${new Intl.NumberFormat('id-ID').format(idrAmount.toFixed(2))}`;
                    document.getElementById('idrCalculation').style.display = 'block';
                } else {
                    document.getElementById('idrCalculation').style.display = 'none';
                }
            },

            // Handle transaction type change
            handleTransactionTypeChange(type) {
                const paymentSelect = document.getElementById('txPaymentMethod');
                paymentSelect.innerHTML = '<option value="">Select Method</option>';

                if (type === 'transfer') {
                    paymentSelect.innerHTML += `
                        <option value="bank_to_cash">Bank → Cash (Withdrawal)</option>
                        <option value="cash_to_bank">Cash → Bank (Deposit)</option>
                    `;
                } else {
                    paymentSelect.innerHTML += `
                        <option value="bank">Bank Transfer</option>
                        <option value="cash">Cash</option>
                    `;
                }

                // Update category dropdown based on transaction type
                this.updateCategoryDropdowns(type);
            },

            // Load categories (now supports typed categories)
            async loadCategories() {
                const stored = await this.loadData(this.storageKeys.categories);
                // Migration: convert old array format to new typed format
                if (Array.isArray(stored) && stored.length > 0 && typeof stored[0] === 'string') {
                    // Old format - migrate to new format
                    const migratedCategories = {
                        income: ['Salary', 'Freelance', 'Investment', 'Other Income'],
                        expense: stored,
                        transfer: ['Bank Transfer', 'Cash Withdrawal', 'Cash Deposit']
                    };
                    await this.saveData(this.storageKeys.categories, migratedCategories);
                    this.state.categories = migratedCategories;
                } else if (stored && typeof stored === 'object' && !Array.isArray(stored)) {
                    this.state.categories = stored;
                } else {
                    this.state.categories = {
                        income: ['Salary', 'Freelance', 'Investment', 'Bonus', 'Other Income'],
                        expense: ['Food & Dining', 'Transportation', 'Utilities', 'Shopping', 'Entertainment', 'Healthcare', 'Education', 'Other'],
                        transfer: ['Bank Transfer', 'Cash Withdrawal', 'Cash Deposit', 'Investment Transfer']
                    };
                }
                return this.state.categories;
            },

            // Get categories by type
            getCategoriesByType(type) {
                return this.state.categories[type] || [];
            },

            // Get all categories as flat array
            getAllCategoriesFlat() {
                const categories = this.state.categories;
                return [...(categories.income || []), ...(categories.expense || []), ...(categories.transfer || [])];
            },

            // Update category dropdowns
            async updateCategoryDropdowns(transactionType = null) {
                const categories = await this.loadCategories();
                const transactionCategorySelect = document.getElementById('txCategory');
                const filterCategorySelect = document.getElementById('categoryFilter');

                // Clear and repopulate transaction category (based on type)
                transactionCategorySelect.innerHTML = '<option value="">Select Category</option>';

                if (transactionType && categories[transactionType]) {
                    categories[transactionType].forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        transactionCategorySelect.appendChild(option);
                    });
                } else {
                    // Show all categories
                    Object.keys(categories).forEach(type => {
                        categories[type].forEach(category => {
                            const option = document.createElement('option');
                            option.value = category;
                            option.textContent = category;
                            transactionCategorySelect.appendChild(option);
                        });
                    });
                }

                // Filter always shows all categories
                filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
                Object.keys(categories).forEach(type => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = type.charAt(0).toUpperCase() + type.slice(1);
                    categories[type].forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        optgroup.appendChild(option);
                    });
                    filterCategorySelect.appendChild(optgroup);
                });
            },

            // Update description suggestions
            async updateDescriptionSuggestions() {
                const transactions = await this.loadTransactions();
                const suggestions = new Set();
                
                transactions.forEach(tx => {
                    if (tx.description) {
                        suggestions.add(tx.description);
                    }
                });
                
                const datalist = document.getElementById('descriptionSuggestions');
                datalist.innerHTML = '';
                
                suggestions.forEach(suggestion => {
                    const option = document.createElement('option');
                    option.value = suggestion;
                    datalist.appendChild(option);
                });
            },

            // Show category modal
            async showCategoryModal() {
                this.state.currentCategoryTab = 'income';
                document.getElementById('newCategoryType').value = 'income';
                await this.populateCategoryList('income');
                this.switchCategoryTab('income');
                this.showModal('categoryModal');
            },

            // Switch category tab
            switchCategoryTab(type) {
                this.state.currentCategoryTab = type;
                document.getElementById('newCategoryType').value = type;

                // Update tab active states
                document.querySelectorAll('#categoryModal .btn[data-type]').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`#categoryModal .btn[data-type="${type}"]`).classList.add('active');

                // Reload category list for the selected type
                this.populateCategoryList(type);
            },

            // Populate category list
            async populateCategoryList(type = null) {
                const categories = await this.loadCategories();
                const container = document.getElementById('categoryListContainer');
                const categoryType = type || this.state.currentCategoryTab || 'expense';
                const categoryList = categories[categoryType] || [];

                container.innerHTML = '';

                if (categoryList.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No ${categoryType} categories yet</div>`;
                    return;
                }

                categoryList.forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'config-item';
                    categoryDiv.innerHTML = `
                        <span>${category}</span>
                        <button type="button" class="btn btn-danger btn-sm delete-category-btn" data-category="${category}" data-type="${categoryType}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    container.appendChild(categoryDiv);
                });

                // Add event listeners for delete buttons
                container.onclick = async (e) => {
                    if (e.target.closest('.delete-category-btn')) {
                        const btn = e.target.closest('button');
                        const category = btn.dataset.category;
                        const type = btn.dataset.type;
                        await this.deleteCategory(category, type);
                    }
                };
            },

            // Save new category
            async saveNewCategory() {
                const input = document.getElementById('newCategoryName');
                const typeSelect = document.getElementById('newCategoryType');
                const categoryName = input.value.trim();
                const categoryType = typeSelect.value;

                if (!categoryName) {
                    this.showToast('Please enter a category name', 'error');
                    return;
                }

                const categories = await this.loadCategories();

                if (!categories[categoryType]) {
                    categories[categoryType] = [];
                }

                if (!categories[categoryType].includes(categoryName)) {
                    categories[categoryType].push(categoryName);
                    await this.saveData(this.storageKeys.categories, categories);

                    // Update displays
                    this.updateCategoryDropdowns();
                    await this.populateCategoryList(categoryType);

                    input.value = '';
                    this.showToast(`${categoryType.charAt(0).toUpperCase() + categoryType.slice(1)} category added successfully`, 'success');
                } else {
                    this.showToast('Category already exists in this type', 'warning');
                }
            },

            // Delete category
            async deleteCategory(categoryName, categoryType = null) {
                if (!confirm(`Delete category "${categoryName}"? This will not delete transactions in this category.`)) {
                    return;
                }

                const categories = await this.loadCategories();
                const type = categoryType || this.state.currentCategoryTab || 'expense';

                if (categories[type]) {
                    const index = categories[type].indexOf(categoryName);

                    if (index > -1) {
                        categories[type].splice(index, 1);
                        await this.saveData(this.storageKeys.categories, categories);

                        this.updateCategoryDropdowns();
                        await this.populateCategoryList(type);
                        this.showToast('Category deleted', 'success');
                    }
                }
            },

            // Load budget
            async loadBudget() {
                this.state.budget = await this.loadData(this.storageKeys.budget) || {
                    annualIncome: 600000,
                    monthlyBudget: 50000,
                    categoryBudgets: [],
                    lastUpdated: null
                };
                return this.state.budget;
            },

            // Update budget display
            async updateBudgetDisplay() {
                const budget = await this.loadBudget();
                const transactions = await this.loadTransactions();
                const rate = this.config.exchangeRate.current;
                const now = DateTime.now();
                
                // Calculate monthly spent
                const currentMonth = now.toFormat('yyyy-MM');
                const monthlySpent = transactions
                    .filter(tx => {
                        const txDate = DateTime.fromISO(tx.date);
                        return tx.type === 'expense' && 
                               txDate.toFormat('yyyy-MM') === currentMonth;
                    })
                    .reduce((sum, tx) => sum + tx.amountTHB, 0);
                
                const monthlyBudget = budget.monthlyBudget || 0;
                const remaining = monthlyBudget - monthlySpent;
                const usagePercent = monthlyBudget > 0 ? (monthlySpent / monthlyBudget) * 100 : 0;
                
                // Update display
                document.getElementById('monthlyBudgetTHB').textContent = 
                    `฿ ${this.formatCurrency(monthlyBudget)}`;
                document.getElementById('monthlySpentTHB').textContent = 
                    `฿ ${this.formatCurrency(monthlySpent)}`;
                document.getElementById('monthlyRemainingTHB').textContent = 
                    `฿ ${this.formatCurrency(remaining)}`;
                document.getElementById('budgetUsagePercent').textContent = 
                    `${usagePercent.toFixed(1)}%`;
                document.getElementById('budgetMonth').textContent = 
                    now.toFormat('MMMM yyyy');
                
                // Update progress bar
                const progressBar = document.getElementById('budgetProgressBar');
                progressBar.style.width = `${Math.min(usagePercent, 100)}%`;
                
                // Update status text and color
                let statusText = 'Within Budget';
                if (usagePercent >= 100) {
                    progressBar.className = 'progress-fill progress-danger';
                    statusText = 'Over Budget';
                } else if (usagePercent >= 80) {
                    progressBar.className = 'progress-fill progress-warning';
                    statusText = 'Approaching Limit';
                } else {
                    progressBar.className = 'progress-fill progress-good';
                }
                document.getElementById('budgetStatusText').textContent = statusText;
                
                // Update header
                document.getElementById('headerMonthlyBudget').textContent = 
                    `฿ ${this.formatCurrency(monthlyBudget)}`;
                
                // Update chart
                if (this.charts.budget) {
                    this.charts.budget.data.datasets[0].data = [monthlySpent, Math.max(remaining, 0)];
                    this.charts.budget.update();
                }

                // Update category budget breakdown
                await this.updateCategoryBudgetBreakdown(transactions, budget, currentMonth);
            },

            // Update category budget breakdown display
            async updateCategoryBudgetBreakdown(transactions, budget, currentMonth) {
                const breakdownContainer = document.getElementById('categoryBudgetBreakdown');
                const listContainer = document.getElementById('categoryBudgetList');

                if (!budget.categoryBudgets || budget.categoryBudgets.length === 0) {
                    breakdownContainer.style.display = 'none';
                    return;
                }

                // Calculate spending per category
                const categorySpending = {};
                transactions
                    .filter(tx => {
                        const txDate = DateTime.fromISO(tx.date);
                        return tx.type === 'expense' &&
                               txDate.toFormat('yyyy-MM') === currentMonth;
                    })
                    .forEach(tx => {
                        categorySpending[tx.category] = (categorySpending[tx.category] || 0) + tx.amountTHB;
                    });

                // Build breakdown list
                let html = '';
                budget.categoryBudgets.forEach(cb => {
                    if (cb.amount > 0) {
                        const spent = categorySpending[cb.category] || 0;
                        const remaining = cb.amount - spent;
                        const percentage = (spent / cb.amount) * 100;
                        const isOver = percentage >= 100;
                        const isWarning = percentage >= 80 && !isOver;

                        let progressClass = 'progress-good';
                        let statusColor = 'var(--success)';
                        if (isOver) {
                            progressClass = 'progress-danger';
                            statusColor = 'var(--danger)';
                        } else if (isWarning) {
                            progressClass = 'progress-warning';
                            statusColor = 'var(--warning)';
                        }

                        html += `
                            <div style="background: var(--light-gray); padding: 12px; border-radius: var(--radius-md); margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 500; color: var(--text-primary);">${cb.category}</span>
                                    <span style="font-size: 0.85rem; color: ${statusColor};">
                                        ${percentage.toFixed(1)}% used
                                    </span>
                                </div>
                                <div class="progress-bar" style="margin-bottom: 8px;">
                                    <div class="progress-fill ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-secondary);">
                                    <span>Spent: ฿${this.formatCurrency(spent)}</span>
                                    <span>Budget: ฿${this.formatCurrency(cb.amount)}</span>
                                    <span style="color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${remaining >= 0 ? 'Left: ฿' + this.formatCurrency(remaining) : 'Over: ฿' + this.formatCurrency(Math.abs(remaining))}
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                });

                if (html) {
                    listContainer.innerHTML = html;
                    breakdownContainer.style.display = 'block';
                } else {
                    breakdownContainer.style.display = 'none';
                }
            },

            // Format currency
            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            },

            // Show budget modal
            async showBudgetModal() {
                const budget = await this.loadBudget();
                const categories = await this.loadCategories();

                // Populate form fields
                document.getElementById('budgetAnnualIncome').value = budget.annualIncome || 600000;
                document.getElementById('budgetMonthlyLimit').value = budget.monthlyBudget || 50000;
                document.getElementById('budgetSavingsGoal').value = budget.savingsGoal || 10000;

                // Populate category budgets
                const container = document.getElementById('categoryBudgetsContainer');
                container.innerHTML = '';

                categories.forEach(category => {
                    const existingBudget = budget.categoryBudgets?.find(cb => cb.category === category);
                    const categoryDiv = document.createElement('div');
                    categoryDiv.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: var(--white); border-radius: var(--radius-sm);';
                    categoryDiv.innerHTML = `
                        <span style="flex: 1; font-weight: 500;">${category}</span>
                        <div class="input-with-icon" style="width: 150px;">
                            <input type="number" class="form-control category-budget-input" data-category="${category}"
                                   value="${existingBudget?.amount || ''}" placeholder="0" step="0.01" style="padding: 8px 12px;">
                            <span class="input-icon">฿</span>
                        </div>
                    `;
                    container.appendChild(categoryDiv);
                });

                // Add event listeners for category budget inputs
                container.querySelectorAll('.category-budget-input').forEach(input => {
                    input.oninput = () => this.updateCategoryBudgetTotals();
                });

                this.updateBudgetPreview();
                this.updateCategoryBudgetTotals();
                this.showModal('budgetModal');
            },

            // Update budget preview
            updateBudgetPreview() {
                const annualIncome = parseFloat(document.getElementById('budgetAnnualIncome').value) || 0;
                const monthlyLimit = parseFloat(document.getElementById('budgetMonthlyLimit').value) || 0;
                const rate = this.config.exchangeRate.current;

                document.getElementById('budgetMonthlyIncomePreview').textContent = this.formatCurrency(annualIncome / 12);
                document.getElementById('budgetMonthlyLimitIDR').textContent = this.formatCurrency(monthlyLimit * rate);
            },

            // Update category budget totals
            updateCategoryBudgetTotals() {
                const monthlyLimit = parseFloat(document.getElementById('budgetMonthlyLimit').value) || 0;
                let totalCategoryBudgets = 0;

                document.querySelectorAll('.category-budget-input').forEach(input => {
                    totalCategoryBudgets += parseFloat(input.value) || 0;
                });

                const unallocated = monthlyLimit - totalCategoryBudgets;
                document.getElementById('totalCategoryBudgets').textContent = `฿ ${this.formatCurrency(totalCategoryBudgets)}`;
                document.getElementById('unallocatedBudget').textContent = `฿ ${this.formatCurrency(unallocated)}`;
                document.getElementById('unallocatedBudget').style.color = unallocated < 0 ? 'var(--danger)' : 'var(--success)';
            },

            // Save budget configuration
            async saveBudgetConfig() {
                try {
                    const annualIncome = parseFloat(document.getElementById('budgetAnnualIncome').value) || 0;
                    const monthlyBudget = parseFloat(document.getElementById('budgetMonthlyLimit').value) || 0;
                    const savingsGoal = parseFloat(document.getElementById('budgetSavingsGoal').value) || 0;

                    // Collect category budgets
                    const categoryBudgets = [];
                    document.querySelectorAll('.category-budget-input').forEach(input => {
                        const amount = parseFloat(input.value);
                        if (amount > 0) {
                            categoryBudgets.push({
                                category: input.dataset.category,
                                amount: amount
                            });
                        }
                    });

                    const budgetConfig = {
                        annualIncome,
                        monthlyBudget,
                        savingsGoal,
                        categoryBudgets,
                        lastUpdated: DateTime.now().toISO()
                    };

                    await this.saveData(this.storageKeys.budget, budgetConfig);
                    this.updateBudgetDisplay();
                    this.updateInvestmentDisplay();
                    this.hideModal('budgetModal');
                    this.showToast('Budget configuration saved', 'success');
                } catch (error) {
                    console.error('Error saving budget:', error);
                    this.showToast('Error saving budget', 'error');
                }
            },

            // Load investments
            async loadInvestments() {
                this.state.investments = await this.loadData(this.storageKeys.investments) || {
                    allocationPercentage: 20,
                    stockPercentage: 70,
                    cryptoPercentage: 30,
                    stockReturn: 1.5,
                    cryptoReturn: 3.0,
                    actualReturns: [],
                    lastUpdated: null
                };
                return this.state.investments;
            },

            // Update investment display
            async updateInvestmentDisplay() {
                const investments = await this.loadInvestments();
                const budget = await this.loadBudget();
                const rate = this.config.exchangeRate.current;
                
                // Calculate investment amounts
                const annualInvestment = (budget.annualIncome * investments.allocationPercentage) / 100;
                const stockAmount = (annualInvestment * investments.stockPercentage) / 100;
                const cryptoAmount = (annualInvestment * investments.cryptoPercentage) / 100;
                
                // Calculate projected returns
                const stockMonthlyReturn = (stockAmount * investments.stockReturn) / 100;
                const cryptoMonthlyReturn = (cryptoAmount * investments.cryptoReturn) / 100;
                const totalMonthlyReturn = stockMonthlyReturn + cryptoMonthlyReturn;
                const totalAnnualReturn = totalMonthlyReturn * 12;
                
                // Update display
                document.getElementById('stockAmountTHB').textContent = 
                    `฿ ${this.formatCurrency(stockAmount)}`;
                document.getElementById('stockPercentage').textContent = 
                    `${investments.stockPercentage}%`;
                document.getElementById('stockTargetReturn').textContent = 
                    investments.stockReturn.toFixed(1);
                
                document.getElementById('cryptoAmountTHB').textContent = 
                    `฿ ${this.formatCurrency(cryptoAmount)}`;
                document.getElementById('cryptoPercentage').textContent = 
                    `${investments.cryptoPercentage}%`;
                document.getElementById('cryptoTargetReturn').textContent = 
                    investments.cryptoReturn.toFixed(1);
                
                document.getElementById('totalProfitTHB').textContent = 
                    `฿ ${this.formatCurrency(totalMonthlyReturn)}`;
                document.getElementById('annualProfitTHB').textContent = 
                    `฿ ${this.formatCurrency(totalAnnualReturn)}`;
                
                // Update chart
                if (this.charts.investment) {
                    this.charts.investment.data.datasets[0].data = [
                        investments.stockPercentage, 
                        investments.cryptoPercentage
                    ];
                    this.charts.investment.update();
                }
            },

            // Show investment modal
            async showInvestmentModal() {
                const investments = await this.loadInvestments();
                const budget = await this.loadBudget();

                // Populate form fields
                document.getElementById('investmentAllocation').value = investments.allocationPercentage || 20;
                document.getElementById('investmentAllocationSlider').value = investments.allocationPercentage || 20;
                document.getElementById('stockAllocation').value = investments.stockPercentage || 70;
                document.getElementById('stockAllocationSlider').value = investments.stockPercentage || 70;
                document.getElementById('cryptoAllocation').value = investments.cryptoPercentage || 30;
                document.getElementById('cryptoAllocationSlider').value = investments.cryptoPercentage || 30;
                document.getElementById('stockReturn').value = investments.stockReturn || 1.5;
                document.getElementById('cryptoReturn').value = investments.cryptoReturn || 3.0;

                this.updateInvestmentPreview();
                this.showModal('investmentModal');
            },

            // Sync investment slider with input
            syncInvestmentSlider(type, value) {
                const numValue = parseInt(value) || 0;
                if (type === 'allocation') {
                    document.getElementById('investmentAllocation').value = numValue;
                } else if (type === 'stock') {
                    document.getElementById('stockAllocation').value = numValue;
                    // Auto-adjust crypto
                    const cryptoValue = Math.max(0, 100 - numValue);
                    document.getElementById('cryptoAllocation').value = cryptoValue;
                    document.getElementById('cryptoAllocationSlider').value = cryptoValue;
                } else if (type === 'crypto') {
                    document.getElementById('cryptoAllocation').value = numValue;
                    // Auto-adjust stock
                    const stockValue = Math.max(0, 100 - numValue);
                    document.getElementById('stockAllocation').value = stockValue;
                    document.getElementById('stockAllocationSlider').value = stockValue;
                }
                this.updateInvestmentPreview();
            },

            // Sync investment input with slider
            syncInvestmentInput(type, value) {
                const numValue = Math.min(100, Math.max(0, parseInt(value) || 0));
                if (type === 'allocation') {
                    document.getElementById('investmentAllocationSlider').value = numValue;
                } else if (type === 'stock') {
                    document.getElementById('stockAllocationSlider').value = numValue;
                    // Auto-adjust crypto
                    const cryptoValue = Math.max(0, 100 - numValue);
                    document.getElementById('cryptoAllocation').value = cryptoValue;
                    document.getElementById('cryptoAllocationSlider').value = cryptoValue;
                } else if (type === 'crypto') {
                    document.getElementById('cryptoAllocationSlider').value = numValue;
                    // Auto-adjust stock
                    const stockValue = Math.max(0, 100 - numValue);
                    document.getElementById('stockAllocation').value = stockValue;
                    document.getElementById('stockAllocationSlider').value = stockValue;
                }
                this.updateInvestmentPreview();
            },

            // Sync investment amount with percentage slider
            async syncInvestmentAmount(type, value) {
                const budget = await this.loadBudget();
                const annualIncome = budget.annualIncome || 600000;
                const allocationPercent = parseFloat(document.getElementById('investmentAllocation').value) || 0;
                const annualInvestment = (annualIncome * allocationPercent) / 100;

                if (annualInvestment <= 0) {
                    this.showToast('Please set investment allocation first', 'warning');
                    return;
                }

                const amount = parseFloat(value) || 0;
                const percentage = Math.round((amount / annualInvestment) * 100);
                const clampedPercentage = Math.min(100, Math.max(0, percentage));

                if (type === 'stock') {
                    document.getElementById('stockAllocation').value = clampedPercentage;
                    document.getElementById('stockAllocationSlider').value = clampedPercentage;
                    // Auto-adjust crypto
                    const cryptoPercent = Math.max(0, 100 - clampedPercentage);
                    document.getElementById('cryptoAllocation').value = cryptoPercent;
                    document.getElementById('cryptoAllocationSlider').value = cryptoPercent;
                    // Update crypto amount input
                    const cryptoAmount = (annualInvestment * cryptoPercent) / 100;
                    document.getElementById('cryptoAmountInput').value = cryptoAmount.toFixed(2);
                } else if (type === 'crypto') {
                    document.getElementById('cryptoAllocation').value = clampedPercentage;
                    document.getElementById('cryptoAllocationSlider').value = clampedPercentage;
                    // Auto-adjust stock
                    const stockPercent = Math.max(0, 100 - clampedPercentage);
                    document.getElementById('stockAllocation').value = stockPercent;
                    document.getElementById('stockAllocationSlider').value = stockPercent;
                    // Update stock amount input
                    const stockAmount = (annualInvestment * stockPercent) / 100;
                    document.getElementById('stockAmountInput').value = stockAmount.toFixed(2);
                }

                this.updateInvestmentPreview();
            },

            // Update investment preview
            async updateInvestmentPreview() {
                const budget = await this.loadBudget();
                const annualIncome = budget.annualIncome || 600000;

                const allocationPercent = parseFloat(document.getElementById('investmentAllocation').value) || 0;
                const stockPercent = parseFloat(document.getElementById('stockAllocation').value) || 0;
                const cryptoPercent = parseFloat(document.getElementById('cryptoAllocation').value) || 0;
                const stockReturnRate = parseFloat(document.getElementById('stockReturn').value) || 0;
                const cryptoReturnRate = parseFloat(document.getElementById('cryptoReturn').value) || 0;

                const annualInvestment = (annualIncome * allocationPercent) / 100;
                const stockAmount = (annualInvestment * stockPercent) / 100;
                const cryptoAmount = (annualInvestment * cryptoPercent) / 100;

                document.getElementById('annualInvestmentPreview').textContent = this.formatCurrency(annualInvestment);
                document.getElementById('stockAmountPreview').textContent = this.formatCurrency(stockAmount);
                document.getElementById('cryptoAmountPreview').textContent = this.formatCurrency(cryptoAmount);

                // Update amount input fields if they're empty or not focused
                const stockInput = document.getElementById('stockAmountInput');
                const cryptoInput = document.getElementById('cryptoAmountInput');
                if (document.activeElement !== stockInput) {
                    stockInput.value = stockAmount.toFixed(2);
                }
                if (document.activeElement !== cryptoInput) {
                    cryptoInput.value = cryptoAmount.toFixed(2);
                }

                // Calculate projected returns
                const stockMonthlyReturn = (stockAmount * stockReturnRate) / 100;
                const cryptoMonthlyReturn = (cryptoAmount * cryptoReturnRate) / 100;
                const totalMonthlyReturn = stockMonthlyReturn + cryptoMonthlyReturn;
                const totalAnnualReturn = totalMonthlyReturn * 12;

                document.getElementById('projectedMonthlyReturn').textContent = `฿ ${this.formatCurrency(totalMonthlyReturn)}`;
                document.getElementById('projectedAnnualReturn').textContent = `฿ ${this.formatCurrency(totalAnnualReturn)}`;

                // Check allocation warning
                const totalAllocation = stockPercent + cryptoPercent;
                const warning = document.getElementById('allocationWarning');
                if (totalAllocation !== 100) {
                    warning.style.display = 'flex';
                } else {
                    warning.style.display = 'none';
                }
            },

            // Save investment configuration
            async saveInvestmentConfig() {
                const stockPercent = parseFloat(document.getElementById('stockAllocation').value) || 0;
                const cryptoPercent = parseFloat(document.getElementById('cryptoAllocation').value) || 0;

                if (stockPercent + cryptoPercent !== 100) {
                    this.showToast('Stock and Crypto allocation must equal 100%', 'error');
                    return;
                }

                try {
                    const investmentConfig = {
                        allocationPercentage: parseFloat(document.getElementById('investmentAllocation').value) || 20,
                        stockPercentage: stockPercent,
                        cryptoPercentage: cryptoPercent,
                        stockReturn: parseFloat(document.getElementById('stockReturn').value) || 1.5,
                        cryptoReturn: parseFloat(document.getElementById('cryptoReturn').value) || 3.0,
                        actualReturns: this.state.investments?.actualReturns || [],
                        lastUpdated: DateTime.now().toISO()
                    };

                    await this.saveData(this.storageKeys.investments, investmentConfig);
                    this.updateInvestmentDisplay();
                    this.hideModal('investmentModal');
                    this.showToast('Investment configuration saved', 'success');
                } catch (error) {
                    console.error('Error saving investment:', error);
                    this.showToast('Error saving investment', 'error');
                }
            },

            // Load utilities
            async loadUtilities() {
                this.state.utilities = await this.loadData(this.storageKeys.utilities) || {
                    electricity: {
                        currentReading: 0,
                        lastReading: null,
                        lastUpdate: null,
                        history: [],
                        rate: 8,
                        threshold: 3
                    },
                    water: {
                        currentReading: 0,
                        lastReading: null,
                        lastUpdate: null,
                        history: [],
                        rate: 20
                    }
                };
                return this.state.utilities;
            },

            // Update utility display
            async updateUtilityDisplay() {
                const utilities = await this.loadUtilities();
                const electricity = utilities.electricity;
                const water = utilities.water;
                
                // Update electricity display
                document.getElementById('electricityLastReading').textContent = 
                    `${this.formatCurrency(electricity.currentReading)} kWh`;
                document.getElementById('electricityLastDate').textContent = 
                    electricity.lastUpdate ? `Date: ${DateTime.fromISO(electricity.lastUpdate).toFormat('dd/MM/yyyy')}` : 'Date: -';
                document.getElementById('electricityLastUpdate').textContent = 
                    electricity.lastUpdate ? DateTime.fromISO(electricity.lastUpdate).toRelative() : '-';
                document.getElementById('electricityRateDisplay').textContent = 
                    electricity.rate.toFixed(2);
                
                // Update water display
                document.getElementById('waterLastReading').textContent = 
                    `${this.formatCurrency(water.currentReading)} units`;
                document.getElementById('waterLastDate').textContent = 
                    water.lastUpdate ? `Date: ${DateTime.fromISO(water.lastUpdate).toFormat('dd/MM/yyyy')}` : 'Date: -';
                document.getElementById('waterLastUpdate').textContent = 
                    water.lastUpdate ? DateTime.fromISO(water.lastUpdate).toRelative() : '-';
                document.getElementById('waterRateDisplay').textContent = 
                    water.rate.toFixed(2);
                
                // Update last updated
                const lastUpdated = electricity.lastUpdate || water.lastUpdate;
                document.getElementById('utilityLastUpdated').textContent = 
                    lastUpdated ? DateTime.fromISO(lastUpdated).toRelative() : '-';
                
                // Update rates in config
                this.config.utilities.electricity.rate = electricity.rate;
                this.config.utilities.water.rate = water.rate;
                this.config.utilities.electricity.threshold = electricity.threshold;
            },

            // Calculate electricity consumption
            async calculateElectricity() {
                const utilities = await this.loadUtilities();
                const electricity = utilities.electricity;
                
                const currentReading = parseFloat(document.getElementById('electricityCurrentReading').value);
                const currentDate = document.getElementById('electricityCurrentDate').value;
                
                if (isNaN(currentReading) || currentReading < 0 || !currentDate) {
                    this.showToast('Please enter valid reading and date', 'error');
                    return;
                }
                
                const lastReading = electricity.currentReading;
                const lastDate = electricity.lastUpdate ? DateTime.fromISO(electricity.lastUpdate).toISODate() : null;
                
                // Calculate consumption
                let totalConsumption = currentReading;
                let daysBetween = 0;
                
                if (lastReading !== null && lastDate !== null && currentReading >= lastReading) {
                    totalConsumption = currentReading - lastReading;
                    
                    const lastDateObj = DateTime.fromISO(lastDate);
                    const currentDateObj = DateTime.fromISO(currentDate);
                    daysBetween = Math.ceil(currentDateObj.diff(lastDateObj, 'days').days);
                } else if (currentReading < lastReading) {
                    this.showToast('Current reading cannot be less than previous reading', 'error');
                    return;
                }
                
                const dailyAverage = daysBetween > 0 ? totalConsumption / daysBetween : 0;
                const cost = totalConsumption * electricity.rate;
                
                // Update display
                document.getElementById('electricityTotal').textContent = `${totalConsumption.toFixed(2)} kWh`;
                document.getElementById('electricityDays').textContent = `${daysBetween} days`;
                document.getElementById('electricityAverage').textContent = `${dailyAverage.toFixed(2)} kWh/day`;
                document.getElementById('electricityCostTHB').textContent = `฿ ${this.formatCurrency(cost)}`;
                
                // Show/hide warning
                const warningElement = document.getElementById('electricityWarning');
                const threshold = electricity.threshold;
                document.getElementById('electricityThreshold').textContent = threshold.toFixed(2);
                
                if (dailyAverage > threshold) {
                    warningElement.style.display = 'flex';
                } else {
                    warningElement.style.display = 'none';
                }
                
                // Show calculation result
                document.getElementById('electricityCalcResult').style.display = 'block';
                
                // Store calculation data for saving
                this.state.pendingElectricity = {
                    reading: currentReading,
                    date: currentDate,
                    consumption: totalConsumption,
                    days: daysBetween,
                    dailyAverage: dailyAverage,
                    cost: cost
                };
            },

            // Save electricity reading
            async saveElectricityReading() {
                if (!this.state.pendingElectricity) {
                    this.showToast('Please calculate consumption first', 'error');
                    return;
                }
                
                try {
                    const utilities = await this.loadUtilities();
                    const pending = this.state.pendingElectricity;
                    
                    // Update utility data
                    utilities.electricity.lastReading = utilities.electricity.currentReading;
                    utilities.electricity.currentReading = pending.reading;
                    utilities.electricity.lastUpdate = DateTime.now().toISO();
                    
                    // Add to history
                    utilities.electricity.history.unshift({
                        ...pending,
                        timestamp: DateTime.now().toISO()
                    });
                    
                    // Keep only last 100 readings
                    if (utilities.electricity.history.length > 100) {
                        utilities.electricity.history.length = 100;
                    }
                    
                    // Save data
                    await this.saveData(this.storageKeys.utilities, utilities);
                    
                    // Clear pending data
                    delete this.state.pendingElectricity;
                    
                    // Update display
                    this.updateUtilityDisplay();
                    
                    // Hide calculation result
                    document.getElementById('electricityCalcResult').style.display = 'none';
                    
                    // Clear input
                    document.getElementById('electricityCurrentReading').value = '';
                    
                    this.showToast('Electricity reading saved', 'success');
                    
                } catch (error) {
                    console.error('Error saving electricity reading:', error);
                    this.showToast('Error saving reading', 'error');
                }
            },

            // Cancel electricity calculation
            cancelElectricityCalculation() {
                document.getElementById('electricityCalcResult').style.display = 'none';
                delete this.state.pendingElectricity;
            },

            // Calculate water consumption
            async calculateWater() {
                const utilities = await this.loadUtilities();
                const water = utilities.water;
                
                const currentReading = parseFloat(document.getElementById('waterCurrentReading').value);
                const currentDate = document.getElementById('waterCurrentDate').value;
                
                if (isNaN(currentReading) || currentReading < 0 || !currentDate) {
                    this.showToast('Please enter valid reading and date', 'error');
                    return;
                }
                
                const lastReading = water.currentReading;
                const lastDate = water.lastUpdate ? DateTime.fromISO(water.lastUpdate).toISODate() : null;
                
                // Calculate consumption
                let totalConsumption = currentReading;
                let daysBetween = 0;
                
                if (lastReading !== null && lastDate !== null && currentReading >= lastReading) {
                    totalConsumption = currentReading - lastReading;
                    
                    const lastDateObj = DateTime.fromISO(lastDate);
                    const currentDateObj = DateTime.fromISO(currentDate);
                    daysBetween = Math.ceil(currentDateObj.diff(lastDateObj, 'days').days);
                } else if (currentReading < lastReading) {
                    this.showToast('Current reading cannot be less than previous reading', 'error');
                    return;
                }
                
                const dailyAverage = daysBetween > 0 ? totalConsumption / daysBetween : 0;
                const cost = totalConsumption * water.rate;
                
                // Update display
                document.getElementById('waterTotal').textContent = `${totalConsumption.toFixed(2)} units`;
                document.getElementById('waterDays').textContent = `${daysBetween} days`;
                document.getElementById('waterAverage').textContent = `${dailyAverage.toFixed(2)} units/day`;
                document.getElementById('waterCostTHB').textContent = `฿ ${this.formatCurrency(cost)}`;
                
                // Show calculation result
                document.getElementById('waterCalcResult').style.display = 'block';
                
                // Store calculation data for saving
                this.state.pendingWater = {
                    reading: currentReading,
                    date: currentDate,
                    consumption: totalConsumption,
                    days: daysBetween,
                    dailyAverage: dailyAverage,
                    cost: cost
                };
            },

            // Save water reading
            async saveWaterReading() {
                if (!this.state.pendingWater) {
                    this.showToast('Please calculate consumption first', 'error');
                    return;
                }
                
                try {
                    const utilities = await this.loadUtilities();
                    const pending = this.state.pendingWater;
                    
                    // Update utility data
                    utilities.water.lastReading = utilities.water.currentReading;
                    utilities.water.currentReading = pending.reading;
                    utilities.water.lastUpdate = DateTime.now().toISO();
                    
                    // Add to history
                    utilities.water.history.unshift({
                        ...pending,
                        timestamp: DateTime.now().toISO()
                    });
                    
                    // Keep only last 100 readings
                    if (utilities.water.history.length > 100) {
                        utilities.water.history.length = 100;
                    }
                    
                    // Save data
                    await this.saveData(this.storageKeys.utilities, utilities);
                    
                    // Clear pending data
                    delete this.state.pendingWater;
                    
                    // Update display
                    this.updateUtilityDisplay();
                    
                    // Hide calculation result
                    document.getElementById('waterCalcResult').style.display = 'none';
                    
                    // Clear input
                    document.getElementById('waterCurrentReading').value = '';
                    
                    this.showToast('Water reading saved', 'success');
                    
                } catch (error) {
                    console.error('Error saving water reading:', error);
                    this.showToast('Error saving reading', 'error');
                }
            },

            // Cancel water calculation
            cancelWaterCalculation() {
                document.getElementById('waterCalcResult').style.display = 'none';
                delete this.state.pendingWater;
            },

            // Show utility settings
            async showUtilitySettings() {
                // Populate settings form with current values
                const utilities = await this.loadUtilities();
                
                document.getElementById('electricityRate').value = utilities.electricity.rate;
                document.getElementById('waterRate').value = utilities.water.rate;
                document.getElementById('electricityThreshold').value = utilities.electricity.threshold;
                
                this.showModal('settingsModal');
            },

            // Show utility history
            async showUtilityHistory() {
                const utilities = await this.loadUtilities();

                // Calculate electricity totals
                let electricityTotalConsumption = 0;
                let electricityTotalCost = 0;
                let electricityTotalDays = 0;
                utilities.electricity.history.forEach(reading => {
                    electricityTotalConsumption += reading.consumption || 0;
                    electricityTotalCost += reading.cost || 0;
                    electricityTotalDays += reading.days || 0;
                });
                const electricityAvgDaily = electricityTotalDays > 0 ? electricityTotalConsumption / electricityTotalDays : 0;

                // Calculate water totals
                let waterTotalConsumption = 0;
                let waterTotalCost = 0;
                let waterTotalDays = 0;
                utilities.water.history.forEach(reading => {
                    waterTotalConsumption += reading.consumption || 0;
                    waterTotalCost += reading.cost || 0;
                    waterTotalDays += reading.days || 0;
                });
                const waterAvgDaily = waterTotalDays > 0 ? waterTotalConsumption / waterTotalDays : 0;

                // Update summary displays
                document.getElementById('electricityTotalConsumption').textContent = `${electricityTotalConsumption.toFixed(2)} kWh`;
                document.getElementById('electricityTotalCost').textContent = `฿ ${this.formatCurrency(electricityTotalCost)}`;
                document.getElementById('electricityAvgDaily').textContent = `${electricityAvgDaily.toFixed(2)} kWh`;

                document.getElementById('waterTotalConsumption').textContent = `${waterTotalConsumption.toFixed(2)} units`;
                document.getElementById('waterTotalCost').textContent = `฿ ${this.formatCurrency(waterTotalCost)}`;
                document.getElementById('waterAvgDaily').textContent = `${waterAvgDaily.toFixed(2)} units`;

                // Populate electricity history table
                const electricityBody = document.getElementById('electricityHistoryBody');
                electricityBody.innerHTML = '';
                if (utilities.electricity.history.length === 0) {
                    electricityBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--text-secondary);">No electricity readings recorded</td></tr>';
                } else {
                    utilities.electricity.history.forEach(reading => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${DateTime.fromISO(reading.timestamp).toFormat('dd/MM/yyyy')}</td>
                            <td>${reading.reading?.toFixed(2) || '-'} kWh</td>
                            <td>${reading.consumption?.toFixed(2) || '0'} kWh</td>
                            <td>${reading.days || '0'} days</td>
                            <td>${reading.dailyAverage?.toFixed(2) || '0'} kWh/day</td>
                            <td>฿ ${this.formatCurrency(reading.cost || 0)}</td>
                        `;
                        electricityBody.appendChild(row);
                    });
                }

                // Populate water history table
                const waterBody = document.getElementById('waterHistoryBody');
                waterBody.innerHTML = '';
                if (utilities.water.history.length === 0) {
                    waterBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--text-secondary);">No water readings recorded</td></tr>';
                } else {
                    utilities.water.history.forEach(reading => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${DateTime.fromISO(reading.timestamp).toFormat('dd/MM/yyyy')}</td>
                            <td>${reading.reading?.toFixed(2) || '-'} units</td>
                            <td>${reading.consumption?.toFixed(2) || '0'} units</td>
                            <td>${reading.days || '0'} days</td>
                            <td>${reading.dailyAverage?.toFixed(2) || '0'} units/day</td>
                            <td>฿ ${this.formatCurrency(reading.cost || 0)}</td>
                        `;
                        waterBody.appendChild(row);
                    });
                }

                // Show electricity tab by default
                this.switchUtilityHistoryTab('electricity');
                this.showModal('utilityHistoryModal');
            },

            // Switch utility history tab
            switchUtilityHistoryTab(tab) {
                const electricityTab = document.getElementById('electricityHistoryTab');
                const waterTab = document.getElementById('waterHistoryTab');
                const electricityContent = document.getElementById('electricityHistoryContent');
                const waterContent = document.getElementById('waterHistoryContent');

                if (tab === 'electricity') {
                    electricityTab.classList.add('active');
                    waterTab.classList.remove('active');
                    electricityContent.style.display = 'block';
                    waterContent.style.display = 'none';
                } else {
                    electricityTab.classList.remove('active');
                    waterTab.classList.add('active');
                    electricityContent.style.display = 'none';
                    waterContent.style.display = 'block';
                }
            },

            // Show past reading modal
            showPastReadingModal() {
                const today = DateTime.now().toFormat('yyyy-MM-dd');
                document.getElementById('pastReadingType').value = 'electricity';
                document.getElementById('pastReadingValue').value = '';
                document.getElementById('pastReadingDate').value = today;
                document.getElementById('pastReadingNotes').value = '';
                this.showModal('pastReadingModal');
            },

            // Save past reading
            async savePastReading() {
                const type = document.getElementById('pastReadingType').value;
                const value = parseFloat(document.getElementById('pastReadingValue').value);
                const date = document.getElementById('pastReadingDate').value;
                const notes = document.getElementById('pastReadingNotes').value;

                if (!value || isNaN(value) || value < 0) {
                    this.showToast('Please enter a valid reading value', 'error');
                    return;
                }

                if (!date) {
                    this.showToast('Please select a date for the reading', 'error');
                    return;
                }

                const utilities = await this.loadUtilities();
                const utilityData = utilities[type];
                const rate = this.config.utilities[type].rate;

                // Create new reading entry
                const newReading = {
                    id: Date.now(),
                    timestamp: DateTime.fromISO(date).toISO(),
                    date: date,
                    reading: value,
                    consumption: 0,
                    days: 0,
                    dailyAverage: 0,
                    cost: 0,
                    notes: notes || ''
                };

                // Insert reading in chronological order
                let history = [...utilityData.history, newReading];
                history.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                // Recalculate consumption for all readings after insertion
                for (let i = 0; i < history.length; i++) {
                    if (i === 0) {
                        // First reading - no consumption to calculate
                        history[i].consumption = 0;
                        history[i].days = 0;
                        history[i].dailyAverage = 0;
                        history[i].cost = 0;
                    } else {
                        const prevReading = history[i - 1];
                        const currentDate = DateTime.fromISO(history[i].timestamp);
                        const prevDate = DateTime.fromISO(prevReading.timestamp);
                        const days = currentDate.diff(prevDate, 'days').days;
                        const consumption = history[i].reading - prevReading.reading;

                        if (consumption >= 0 && days > 0) {
                            history[i].consumption = consumption;
                            history[i].days = Math.round(days);
                            history[i].dailyAverage = consumption / days;
                            history[i].cost = consumption * rate;
                        } else {
                            history[i].consumption = 0;
                            history[i].days = Math.round(days);
                            history[i].dailyAverage = 0;
                            history[i].cost = 0;
                        }
                    }
                }

                // Update utilities data
                utilities[type].history = history;

                // Update current reading to the latest
                if (history.length > 0) {
                    const latestReading = history[history.length - 1];
                    utilities[type].currentReading = latestReading.reading;
                    utilities[type].lastReadingDate = latestReading.date;
                }

                await this.saveUtilities(utilities);
                await this.updateUtilityDisplays();

                this.hideModal('pastReadingModal');
                this.showToast(`Past ${type} reading added successfully`, 'success');
            },

            // Export utility data
            async exportUtilityData() {
                const utilities = await this.loadUtilities();
                
                let csvContent = 'data:text/csv;charset=utf-8,';
                csvContent += 'Type,Date,Reading,Consumption,Days,Daily Average,Cost (THB)\n';
                
                // Export electricity data
                utilities.electricity.history.forEach(reading => {
                    csvContent += `Electricity,${reading.date},${reading.reading},${reading.consumption},${reading.days},${reading.dailyAverage},${reading.cost}\n`;
                });
                
                // Export water data
                utilities.water.history.forEach(reading => {
                    csvContent += `Water,${reading.date},${reading.reading},${reading.consumption},${reading.days},${reading.dailyAverage},${reading.cost}\n`;
                });
                
                // Add current readings
                csvContent += `Electricity,Current,${utilities.electricity.currentReading},,,,\n`;
                csvContent += `Water,Current,${utilities.water.currentReading},,,,\n`;
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `utility_data_${DateTime.now().toFormat('yyyy-MM-dd')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('Utility data exported', 'success');
            },

            // Update transaction list
            async updateTransactionList() {
                const transactions = await this.loadTransactions();
                const tbody = document.getElementById('transactionsBody');
                const emptyRow = document.getElementById('emptyStateRow');
                
                // Apply filters
                let filteredTransactions = this.applyTransactionFilters(transactions);
                
                // Apply pagination
                const startIndex = (this.state.pagination.currentPage - 1) * this.state.pagination.pageSize;
                const endIndex = startIndex + this.state.pagination.pageSize;
                const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);
                
                // Clear table
                tbody.innerHTML = '';
                
                if (paginatedTransactions.length === 0) {
                    tbody.appendChild(emptyRow);
                    emptyRow.style.display = '';
                } else {
                    emptyRow.style.display = 'none';
                    
                    // Display transactions
                    paginatedTransactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        
                        // Determine badge class
                        let badgeClass = '';
                        switch (transaction.type) {
                            case 'income':
                                badgeClass = 'badge-income';
                                break;
                            case 'expense':
                                badgeClass = 'badge-expense';
                                break;
                            case 'transfer':
                                badgeClass = 'badge-transfer';
                                break;
                        }
                        
                        row.innerHTML = `
                            <td>
                                <input type="checkbox" class="transaction-checkbox" data-id="${transaction.id}">
                            </td>
                            <td>${DateTime.fromISO(transaction.date).toFormat('dd/MM/yyyy')}</td>
                            <td>
                                <div style="font-weight: 600;">${transaction.description}</div>
                                ${transaction.notes ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">${transaction.notes}</div>` : ''}
                            </td>
                            <td>
                                <div style="font-weight: 600; color: ${transaction.type === 'income' ? 'var(--success)' : transaction.type === 'expense' ? 'var(--danger)' : 'var(--warning)'};">
                                    ฿ ${this.formatCurrency(transaction.amountTHB)}
                                </div>
                            </td>
                            <td>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    Rp ${this.formatCurrency(transaction.amountIDR)}
                                </div>
                            </td>
                            <td><span class="badge">${transaction.category}</span></td>
                            <td><span class="badge ${badgeClass}">${transaction.type}</span></td>
                            <td>${transaction.paymentMethod}</td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-sm btn-outline edit-transaction-btn" data-id="${transaction.id}" title="Edit transaction">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline delete-transaction-btn" data-id="${transaction.id}" title="Delete transaction">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Add event listeners for edit and delete buttons
                    tbody.addEventListener('click', (e) => {
                        if (e.target.closest('.edit-transaction-btn')) {
                            const transactionId = e.target.closest('button').dataset.id;
                            this.showEditTransactionModal(transactionId);
                        }
                        if (e.target.closest('.delete-transaction-btn')) {
                            const transactionId = e.target.closest('button').dataset.id;
                            this.deleteTransaction(transactionId);
                        }
                    });
                }
                
                // Update stats
                document.getElementById('shownCount').textContent = paginatedTransactions.length;
                document.getElementById('totalCount').textContent = filteredTransactions.length;
                document.getElementById('totalTransactions').textContent = transactions.length;
                
                // Update pagination controls
                this.updatePaginationControls(filteredTransactions.length);
            },

            // Apply transaction filters
            applyTransactionFilters(transactions) {
                const { type, category, startDate, endDate } = this.state.activeFilters;
                
                let filtered = transactions;
                
                if (type !== 'all') {
                    filtered = filtered.filter(tx => tx.type === type);
                }
                
                if (category) {
                    filtered = filtered.filter(tx => tx.category === category);
                }
                
                if (startDate) {
                    filtered = filtered.filter(tx => tx.date >= startDate);
                }
                
                if (endDate) {
                    filtered = filtered.filter(tx => tx.date <= endDate);
                }
                
                return filtered;
            },

            // Update pagination controls
            updatePaginationControls(totalItems) {
                const totalPages = Math.ceil(totalItems / this.state.pagination.pageSize);
                const currentPage = this.state.pagination.currentPage;
                
                document.getElementById('currentPage').textContent = currentPage;
                document.getElementById('prevPageBtn').disabled = currentPage === 1;
                document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
                
                this.state.pagination.totalItems = totalItems;
            },

            // Filter transactions
            async filterTransactions(filter) {
                this.state.activeFilters.type = filter;
                this.state.pagination.currentPage = 1;
                
                // Update active button
                document.querySelectorAll('.table-filters .btn[data-filter]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === filter);
                });
                
                await this.updateTransactionList();
            },

            // Apply advanced filters
            async applyAdvancedFilters() {
                this.state.activeFilters.category = document.getElementById('categoryFilter').value;
                this.state.activeFilters.startDate = document.getElementById('startDateFilter').value;
                this.state.activeFilters.endDate = document.getElementById('endDateFilter').value;
                this.state.pagination.currentPage = 1;
                
                await this.updateTransactionList();
            },

            // Clear filters
            async clearFilters() {
                this.state.activeFilters = {
                    type: 'all',
                    category: '',
                    startDate: '',
                    endDate: ''
                };
                
                document.querySelector('.table-filters .btn[data-filter="all"]').classList.add('active');
                document.querySelectorAll('.table-filters .btn[data-filter]:not([data-filter="all"])').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById('categoryFilter').value = '';
                document.getElementById('startDateFilter').value = '';
                document.getElementById('endDateFilter').value = '';
                
                this.state.pagination.currentPage = 1;
                
                await this.updateTransactionList();
            },

            // Delete transaction
            async deleteTransaction(transactionId) {
                if (!confirm('Are you sure you want to delete this transaction?')) {
                    return;
                }
                
                try {
                    const transactions = await this.loadTransactions();
                    const transactionIndex = transactions.findIndex(tx => tx.id === transactionId);
                    
                    if (transactionIndex === -1) {
                        this.showToast('Transaction not found', 'error');
                        return;
                    }
                    
                    const deletedTransaction = transactions[transactionIndex];
                    
                    // Remove transaction
                    transactions.splice(transactionIndex, 1);
                    await this.saveData(this.storageKeys.transactions, transactions);
                    
                    // Recalculate balances
                    await this.recalculateBalances();
                    
                    // Update displays
                    this.updateAllDisplays();
                    
                    this.showToast('Transaction deleted', 'success');
                    
                } catch (error) {
                    console.error('Error deleting transaction:', error);
                    this.showToast('Error deleting transaction', 'error');
                }
            },

            // Delete selected transactions
            async deleteSelectedTransactions() {
                const selectedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
                
                if (selectedIds.length === 0) {
                    this.showToast('No transactions selected', 'error');
                    return;
                }
                
                if (!confirm(`Delete ${selectedIds.length} selected transaction(s)?`)) {
                    return;
                }
                
                try {
                    const transactions = await this.loadTransactions();
                    const filteredTransactions = transactions.filter(tx => !selectedIds.includes(tx.id));
                    
                    await this.saveData(this.storageKeys.transactions, filteredTransactions);
                    
                    // Recalculate balances
                    await this.recalculateBalances();
                    
                    // Update displays
                    this.updateAllDisplays();
                    
                    this.showToast(`${selectedIds.length} transaction(s) deleted`, 'success');
                    
                } catch (error) {
                    console.error('Error deleting transactions:', error);
                    this.showToast('Error deleting transactions', 'error');
                }
            },

            // Recalculate balances
            async recalculateBalances() {
                const transactions = await this.loadTransactions();
                const balances = await this.loadData(this.storageKeys.balances) || { bank: 0, cash: 0 };
                const initialBalances = { ...balances };
                
                // Reset to initial state
                balances.bank = initialBalances.bank || 0;
                balances.cash = initialBalances.cash || 0;
                
                // Sort transactions by date
                const sortedTransactions = [...transactions].sort((a, b) => 
                    DateTime.fromISO(a.date).toMillis() - DateTime.fromISO(b.date).toMillis()
                );
                
                // Recalculate balances
                sortedTransactions.forEach(transaction => {
                    const amount = transaction.amountTHB;
                    
                    switch (transaction.type) {
                        case 'income':
                            if (transaction.paymentMethod === 'bank') {
                                balances.bank += amount;
                            } else if (transaction.paymentMethod === 'cash') {
                                balances.cash += amount;
                            }
                            break;
                            
                        case 'expense':
                            if (transaction.paymentMethod === 'bank') {
                                balances.bank -= amount;
                            } else if (transaction.paymentMethod === 'cash') {
                                balances.cash -= amount;
                            }
                            break;
                            
                        case 'transfer':
                            if (transaction.paymentMethod === 'bank_to_cash') {
                                balances.bank -= amount;
                                balances.cash += amount;
                            } else if (transaction.paymentMethod === 'cash_to_bank') {
                                balances.cash -= amount;
                                balances.bank += amount;
                            }
                            break;
                    }
                    
                    // Update transaction with recalculated balances
                    transaction.bankBalanceAfter = balances.bank;
                    transaction.cashBalanceAfter = balances.cash;
                });
                
                // Save updated transactions and balances
                balances.lastUpdated = DateTime.now().toISO();
                await this.saveData(this.storageKeys.transactions, sortedTransactions);
                await this.saveData(this.storageKeys.balances, balances);
            },

            // Export to CSV
            async exportToCSV() {
                const transactions = await this.loadTransactions();
                const budget = await this.loadBudget();
                const investments = await this.loadInvestments();
                const utilities = await this.loadUtilities();
                const balances = await this.loadData(this.storageKeys.balances);
                
                let csvContent = 'data:text/csv;charset=utf-8,';
                
                // Export transactions
                csvContent += 'TRANSACTIONS\n';
                csvContent += 'Date,Description,Amount (THB),Amount (IDR),Type,Category,Payment Method,Notes,Exchange Rate\n';
                
                transactions.forEach(tx => {
                    csvContent += `${tx.date},"${tx.description}",${tx.amountTHB},${tx.amountIDR},${tx.type},"${tx.category}",${tx.paymentMethod},"${tx.notes || ''}",${tx.exchangeRate}\n`;
                });
                
                csvContent += '\n\nBUDGET\n';
                csvContent += 'Annual Income (THB),Monthly Budget (THB)\n';
                csvContent += `${budget.annualIncome},${budget.monthlyBudget}\n`;
                
                csvContent += '\n\nINVESTMENTS\n';
                csvContent += 'Type,Allocation %,Amount (THB),Target Return %\n';
                csvContent += `Stock Market,${investments.stockPercentage},${(budget.annualIncome * investments.allocationPercentage * investments.stockPercentage) / 10000},${investments.stockReturn}\n`;
                csvContent += `Cryptocurrency,${investments.cryptoPercentage},${(budget.annualIncome * investments.allocationPercentage * investments.cryptoPercentage) / 10000},${investments.cryptoReturn}\n`;
                
                csvContent += '\n\nBALANCES\n';
                csvContent += 'Type,Balance (THB),Balance (IDR)\n';
                csvContent += `Bank,${balances.bank},${balances.bank * this.config.exchangeRate.current}\n`;
                csvContent += `Cash,${balances.cash},${balances.cash * this.config.exchangeRate.current}\n`;
                
                csvContent += '\n\nELECTRICITY READINGS\n';
                csvContent += 'Date,Reading (kWh),Consumption (kWh),Days,Daily Average,Cost (THB)\n';
                utilities.electricity.history.forEach(reading => {
                    csvContent += `${reading.date},${reading.reading},${reading.consumption},${reading.days},${reading.dailyAverage},${reading.cost}\n`;
                });
                
                csvContent += '\n\nWATER READINGS\n';
                csvContent += 'Date,Reading (units),Consumption (units),Days,Daily Average,Cost (THB)\n';
                utilities.water.history.forEach(reading => {
                    csvContent += `${reading.date},${reading.reading},${reading.consumption},${reading.days},${reading.dailyAverage},${reading.cost}\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `finance_export_${DateTime.now().toFormat('yyyy-MM-dd_HH-mm')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('Data exported successfully', 'success');
            },

            // Update sheets status
            updateSheetsStatus() {
                const statusText = document.getElementById('sheetsStatusText');
                const connectionStatus = document.getElementById('sheetsConnectionStatus');
                
                if (this.config.googleSheets.enabled) {
                    statusText.textContent = 'Connected';
                    statusText.style.color = 'var(--success)';
                    connectionStatus.innerHTML = '<i class="fas fa-circle" style="color: var(--success);"></i> Status: Connected';
                } else {
                    statusText.textContent = 'Not Connected';
                    statusText.style.color = 'var(--text-secondary)';
                    connectionStatus.innerHTML = '<i class="fas fa-circle" style="color: var(--warning);"></i> Status: Not Connected';
                }
            },

            // Test sheets connection
            async testSheetsConnection() {
                if (!this.config.googleSheets.webAppUrl) {
                    this.showToast('Please enter a Web App URL', 'error');
                    return;
                }
                
                try {
                    this.state.loading.sheetsSync = true;
                    
                    // Simple test request
                    const response = await fetch(this.config.googleSheets.webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'test',
                            timestamp: DateTime.now().toISO()
                        })
                    });
                    
                    if (response.ok) {
                        this.showToast('Connection successful!', 'success');
                        document.getElementById('sheetsConnectionStatus').innerHTML = 
                            '<i class="fas fa-circle" style="color: var(--success);"></i> Status: Connected (Test Successful)';
                    } else {
                        throw new Error('Test failed');
                    }
                    
                } catch (error) {
                    console.error('Connection test failed:', error);
                    this.showToast('Connection test failed. Check URL and permissions.', 'error');
                    document.getElementById('sheetsConnectionStatus').innerHTML = 
                        '<i class="fas fa-circle" style="color: var(--danger);"></i> Status: Connection Failed';
                } finally {
                    this.state.loading.sheetsSync = false;
                }
            },

            // Sync transaction with Google Sheets
            async syncTransactionWithSheets(transaction) {
                if (!this.config.googleSheets.enabled || !navigator.onLine) {
                    return;
                }
                
                try {
                    const response = await fetch(this.config.googleSheets.webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'addTransaction',
                            data: transaction
                        })
                    });
                    
                    if (response.ok) {
                        // Mark as synced
                        const transactions = await this.loadTransactions();
                        const txIndex = transactions.findIndex(tx => tx.id === transaction.id);
                        if (txIndex > -1) {
                            transactions[txIndex].synced = true;
                            await this.saveData(this.storageKeys.transactions, transactions);
                        }
                    }
                } catch (error) {
                    console.error('Sheets sync error:', error);
                }
            },

            // Sync with Google Sheets
            async syncWithGoogleSheets() {
                if (!this.config.googleSheets.enabled || !navigator.onLine) {
                    return;
                }
                
                try {
                    this.state.loading.sheetsSync = true;
                    
                    // Get unsynced transactions
                    const transactions = await this.loadTransactions();
                    const unsyncedTransactions = transactions.filter(tx => !tx.synced);
                    
                    if (unsyncedTransactions.length === 0) {
                        this.showToast('All data is already synced', 'info');
                        return;
                    }
                    
                    // Sync all unsynced transactions
                    for (const transaction of unsyncedTransactions) {
                        await this.syncTransactionWithSheets(transaction);
                    }
                    
                    this.config.googleSheets.lastSync = DateTime.now().toISO();
                    await this.saveData(this.storageKeys.settings, this.config);
                    
                    this.showToast(`${unsyncedTransactions.length} transaction(s) synced`, 'success');
                    
                } catch (error) {
                    console.error('Sheets sync error:', error);
                    this.showToast('Sync failed. Please check connection.', 'error');
                } finally {
                    this.state.loading.sheetsSync = false;
                }
            },

            // Backup data
            async backupData() {
                try {
                    const backup = {
                        timestamp: DateTime.now().toISO(),
                        version: this.config.version,
                        data: {
                            transactions: await this.loadData(this.storageKeys.transactions),
                            categories: await this.loadData(this.storageKeys.categories),
                            budget: await this.loadData(this.storageKeys.budget),
                            investments: await this.loadData(this.storageKeys.investments),
                            utilities: await this.loadData(this.storageKeys.utilities),
                            balances: await this.loadData(this.storageKeys.balances),
                            settings: this.config
                        }
                    };
                    
                    const backupStr = JSON.stringify(backup, null, 2);
                    const blob = new Blob([backupStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `hans_finance_backup_${DateTime.now().toFormat('yyyy-MM-dd_HH-mm-ss')}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    this.showToast('Backup created successfully', 'success');
                    
                } catch (error) {
                    console.error('Backup error:', error);
                    this.showToast('Error creating backup', 'error');
                }
            },

            // Restore data
            async restoreData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = async (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            
                            if (!confirm('Restore from backup? This will overwrite all current data.')) {
                                return;
                            }
                            
                            // Restore data
                            if (backup.data.transactions) {
                                await this.saveData(this.storageKeys.transactions, backup.data.transactions);
                            }
                            
                            if (backup.data.categories) {
                                await this.saveData(this.storageKeys.categories, backup.data.categories);
                            }
                            
                            if (backup.data.budget) {
                                await this.saveData(this.storageKeys.budget, backup.data.budget);
                            }
                            
                            if (backup.data.investments) {
                                await this.saveData(this.storageKeys.investments, backup.data.investments);
                            }
                            
                            if (backup.data.utilities) {
                                await this.saveData(this.storageKeys.utilities, backup.data.utilities);
                            }
                            
                            if (backup.data.balances) {
                                await this.saveData(this.storageKeys.balances, backup.data.balances);
                            }
                            
                            if (backup.data.settings) {
                                this.config = { ...this.config, ...backup.data.settings };
                                await this.saveData(this.storageKeys.settings, this.config);
                            }
                            
                            // Reload all data
                            await this.loadAllData();
                            
                            this.showToast('Backup restored successfully', 'success');
                            
                        } catch (error) {
                            console.error('Restore error:', error);
                            this.showToast('Invalid backup file', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            },

            // Reset app data
            async resetAppData() {
                if (!confirm('Reset all data? This cannot be undone.')) {
                    return;
                }
                
                if (!confirm('Are you absolutely sure? All your data will be permanently deleted.')) {
                    return;
                }
                
                try {
                    // Clear all storage keys
                    Object.values(this.storageKeys).forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    // Clear any backup files
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('backup_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // Reset state
                    this.state = {
                        isInitialized: false,
                        setupComplete: false,
                        currentStep: 1,
                        totalSteps: 4,
                        activeFilters: {
                            type: 'all',
                            category: '',
                            startDate: '',
                            endDate: ''
                        },
                        pagination: {
                            currentPage: 1,
                            pageSize: 10,
                            totalItems: 0
                        },
                        loading: {
                            exchangeRate: false,
                            sheetsSync: false,
                            dataLoad: false
                        }
                    };
                    
                    // Reload page
                    location.reload();
                    
                } catch (error) {
                    console.error('Reset error:', error);
                    this.showToast('Error resetting data', 'error');
                }
            },

            // Handle keyboard shortcuts
            handleKeyboardShortcuts(e) {
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                // Ctrl + N: New transaction focus
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    document.getElementById('txDescription').focus();
                }
                
                // Ctrl + S: Save/Sync
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (document.getElementById('transactionForm').checkValidity()) {
                        document.getElementById('transactionForm').dispatchEvent(new Event('submit'));
                    } else if (this.config.googleSheets.enabled) {
                        this.syncWithGoogleSheets();
                    }
                }
                
                // Ctrl + E: Export
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    this.exportToCSV();
                }
                
                // Ctrl + ,: Settings
                if (e.ctrlKey && e.key === ',') {
                    e.preventDefault();
                    this.showSettingsModal();
                }
                
                // Ctrl + H: Help
                if (e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    this.showHelpModal();
                }
                
                // Ctrl + R: Refresh exchange rate
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    this.fetchExchangeRate();
                }
            },

            // Show recurring modal
            async showRecurringModal() {
                const categories = await this.loadCategories();

                // Populate category dropdown
                const categorySelect = document.getElementById('recurringCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });

                // Reset form
                document.getElementById('recurringDescription').value = '';
                document.getElementById('recurringAmount').value = '';
                document.getElementById('recurringType').value = 'income';
                document.getElementById('recurringFrequency').value = 'monthly';
                document.getElementById('recurringDay').value = '1';
                document.getElementById('recurringPaymentMethod').value = 'bank';
                document.getElementById('recurringActive').checked = true;

                // Load existing recurring transactions
                await this.loadRecurringList();

                this.showModal('recurringModal');
            },

            // Load recurring transactions list
            async loadRecurringList() {
                const recurring = await this.loadData('recurring_transactions') || [];
                const container = document.getElementById('recurringListContainer');
                container.innerHTML = '';

                if (recurring.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--text-secondary);"><i class="fas fa-redo" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i><p>No recurring transactions set up</p></div>';
                    return;
                }

                recurring.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.cssText = 'display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--light-gray); border-radius: var(--radius-md); margin-bottom: 10px;';
                    itemDiv.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 5px;">${item.description}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                ฿ ${this.formatCurrency(item.amount)} • ${item.frequency} • ${item.type}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="badge ${item.active ? 'badge-income' : ''}" style="${item.active ? '' : 'background: var(--medium-gray); color: var(--text-tertiary);'}">
                                ${item.active ? 'Active' : 'Inactive'}
                            </span>
                            <button class="btn btn-sm btn-outline toggle-recurring-btn" data-index="${index}">
                                <i class="fas ${item.active ? 'fa-pause' : 'fa-play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-recurring-btn" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });

                // Add event listeners
                container.querySelectorAll('.toggle-recurring-btn').forEach(btn => {
                    btn.onclick = () => this.toggleRecurringTransaction(parseInt(btn.dataset.index));
                });
                container.querySelectorAll('.delete-recurring-btn').forEach(btn => {
                    btn.onclick = () => this.deleteRecurringTransaction(parseInt(btn.dataset.index));
                });
            },

            // Add recurring transaction
            async addRecurringTransaction() {
                const description = document.getElementById('recurringDescription').value.trim();
                const amount = parseFloat(document.getElementById('recurringAmount').value);
                const type = document.getElementById('recurringType').value;
                const category = document.getElementById('recurringCategory').value;
                const frequency = document.getElementById('recurringFrequency').value;
                const day = parseInt(document.getElementById('recurringDay').value) || 1;
                const paymentMethod = document.getElementById('recurringPaymentMethod').value;
                const active = document.getElementById('recurringActive').checked;

                if (!description || isNaN(amount) || !category) {
                    this.showToast('Please fill in all required fields', 'error');
                    return;
                }

                try {
                    const recurring = await this.loadData('recurring_transactions') || [];

                    recurring.push({
                        id: `rec_${Date.now()}`,
                        description,
                        amount,
                        type,
                        category,
                        frequency,
                        day,
                        paymentMethod,
                        active,
                        createdAt: DateTime.now().toISO(),
                        lastExecuted: null
                    });

                    await this.saveData('recurring_transactions', recurring);

                    // Reset form
                    document.getElementById('recurringDescription').value = '';
                    document.getElementById('recurringAmount').value = '';
                    document.getElementById('recurringCategory').value = '';

                    await this.loadRecurringList();
                    this.showToast('Recurring transaction added', 'success');
                } catch (error) {
                    console.error('Error adding recurring transaction:', error);
                    this.showToast('Error adding recurring transaction', 'error');
                }
            },

            // Toggle recurring transaction
            async toggleRecurringTransaction(index) {
                try {
                    const recurring = await this.loadData('recurring_transactions') || [];
                    if (recurring[index]) {
                        recurring[index].active = !recurring[index].active;
                        await this.saveData('recurring_transactions', recurring);
                        await this.loadRecurringList();
                        this.showToast('Recurring transaction updated', 'success');
                    }
                } catch (error) {
                    console.error('Error toggling recurring transaction:', error);
                    this.showToast('Error updating recurring transaction', 'error');
                }
            },

            // Delete recurring transaction
            async deleteRecurringTransaction(index) {
                if (!confirm('Delete this recurring transaction?')) return;

                try {
                    const recurring = await this.loadData('recurring_transactions') || [];
                    recurring.splice(index, 1);
                    await this.saveData('recurring_transactions', recurring);
                    await this.loadRecurringList();
                    this.showToast('Recurring transaction deleted', 'success');
                } catch (error) {
                    console.error('Error deleting recurring transaction:', error);
                    this.showToast('Error deleting recurring transaction', 'error');
                }
            },

            // Show account history modal
            async showAccountHistoryModal(accountType) {
                const transactions = await this.loadTransactions();
                const balances = await this.loadData(this.storageKeys.balances) || { bank: 0, cash: 0 };

                // Update title
                const title = accountType === 'bank' ? 'Bank Account History' : 'Cash Wallet History';
                document.getElementById('accountHistoryTitle').innerHTML = `<i class="fas fa-history"></i> ${title}`;

                // Filter transactions for this account type
                const accountTransactions = transactions.filter(tx => {
                    if (accountType === 'bank') {
                        return tx.paymentMethod === 'bank' || tx.paymentMethod === 'bank_to_cash' || tx.paymentMethod === 'cash_to_bank';
                    } else {
                        return tx.paymentMethod === 'cash' || tx.paymentMethod === 'bank_to_cash' || tx.paymentMethod === 'cash_to_bank';
                    }
                });

                // Calculate totals
                let totalIncome = 0;
                let totalExpenses = 0;

                accountTransactions.forEach(tx => {
                    if (tx.type === 'income') {
                        if ((accountType === 'bank' && tx.paymentMethod === 'bank') ||
                            (accountType === 'cash' && tx.paymentMethod === 'cash')) {
                            totalIncome += tx.amountTHB;
                        }
                    } else if (tx.type === 'expense') {
                        if ((accountType === 'bank' && tx.paymentMethod === 'bank') ||
                            (accountType === 'cash' && tx.paymentMethod === 'cash')) {
                            totalExpenses += tx.amountTHB;
                        }
                    } else if (tx.type === 'transfer') {
                        if (accountType === 'bank') {
                            if (tx.paymentMethod === 'cash_to_bank') totalIncome += tx.amountTHB;
                            if (tx.paymentMethod === 'bank_to_cash') totalExpenses += tx.amountTHB;
                        } else {
                            if (tx.paymentMethod === 'bank_to_cash') totalIncome += tx.amountTHB;
                            if (tx.paymentMethod === 'cash_to_bank') totalExpenses += tx.amountTHB;
                        }
                    }
                });

                // Update summary
                document.getElementById('historyCurrentBalance').textContent = `฿ ${this.formatCurrency(balances[accountType] || 0)}`;
                document.getElementById('historyTotalIncome').textContent = `฿ ${this.formatCurrency(totalIncome)}`;
                document.getElementById('historyTotalExpenses').textContent = `฿ ${this.formatCurrency(totalExpenses)}`;

                // Populate history table
                const tbody = document.getElementById('accountHistoryBody');
                tbody.innerHTML = '';

                if (accountTransactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">No transactions found for this account</td></tr>';
                } else {
                    accountTransactions.slice(0, 50).forEach(tx => {
                        const row = document.createElement('tr');
                        let badgeClass = tx.type === 'income' ? 'badge-income' : tx.type === 'expense' ? 'badge-expense' : 'badge-transfer';
                        let amountColor = tx.type === 'income' ? 'var(--success)' : tx.type === 'expense' ? 'var(--danger)' : 'var(--warning)';

                        // Get balance after for this account
                        let balanceAfter = accountType === 'bank' ? tx.bankBalanceAfter : tx.cashBalanceAfter;

                        row.innerHTML = `
                            <td>${DateTime.fromISO(tx.date).toFormat('dd/MM/yyyy')}</td>
                            <td>${tx.description}</td>
                            <td><span class="badge ${badgeClass}">${tx.type}</span></td>
                            <td style="font-weight: 600; color: ${amountColor};">฿ ${this.formatCurrency(tx.amountTHB)}</td>
                            <td>฿ ${this.formatCurrency(balanceAfter || 0)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                this.showModal('accountHistoryModal');
            },

            // Show edit transaction modal
            async showEditTransactionModal(transactionId) {
                const transactions = await this.loadTransactions();
                const transaction = transactions.find(tx => tx.id === transactionId);

                if (!transaction) {
                    this.showToast('Transaction not found', 'error');
                    return;
                }

                const categories = await this.loadCategories();

                // Populate category dropdown
                const categorySelect = document.getElementById('editTxCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    if (category === transaction.category) option.selected = true;
                    categorySelect.appendChild(option);
                });

                // Populate form fields
                document.getElementById('editTxId').value = transaction.id;
                document.getElementById('editTxDate').value = transaction.date;
                document.getElementById('editTxDescription').value = transaction.description;
                document.getElementById('editTxAmount').value = transaction.amountTHB;
                document.getElementById('editTxType').value = transaction.type;
                document.getElementById('editTxPaymentMethod').value = transaction.paymentMethod;
                document.getElementById('editTxNotes').value = transaction.notes || '';

                this.showModal('editTransactionModal');
            },

            // Save edited transaction
            async saveEditedTransaction() {
                const transactionId = document.getElementById('editTxId').value;
                const date = document.getElementById('editTxDate').value;
                const description = document.getElementById('editTxDescription').value.trim();
                const amount = parseFloat(document.getElementById('editTxAmount').value);
                const type = document.getElementById('editTxType').value;
                const category = document.getElementById('editTxCategory').value;
                const paymentMethod = document.getElementById('editTxPaymentMethod').value;
                const notes = document.getElementById('editTxNotes').value.trim();

                if (!date || !description || isNaN(amount) || !type || !category || !paymentMethod) {
                    this.showToast('Please fill in all required fields', 'error');
                    return;
                }

                try {
                    const transactions = await this.loadTransactions();
                    const txIndex = transactions.findIndex(tx => tx.id === transactionId);

                    if (txIndex === -1) {
                        this.showToast('Transaction not found', 'error');
                        return;
                    }

                    // Update transaction
                    transactions[txIndex] = {
                        ...transactions[txIndex],
                        date,
                        description,
                        amountTHB: amount,
                        amountIDR: amount * this.config.exchangeRate.current,
                        type,
                        category,
                        paymentMethod,
                        notes,
                        exchangeRate: this.config.exchangeRate.current,
                        lastModified: DateTime.now().toISO()
                    };

                    await this.saveData(this.storageKeys.transactions, transactions);

                    // Recalculate balances
                    await this.recalculateBalances();

                    // Update displays
                    this.updateAllDisplays();
                    this.hideModal('editTransactionModal');
                    this.showToast('Transaction updated', 'success');
                } catch (error) {
                    console.error('Error saving transaction:', error);
                    this.showToast('Error saving transaction', 'error');
                }
            },

            // Show toast notification
            showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                const container = document.getElementById('toastContainer');
                container.appendChild(toast);
                
                // Add close event
                toast.querySelector('.toast-close').onclick = () => {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 300);
                };
                
                // Auto remove
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.classList.add('hiding');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            },

            // =====================
            // Cloud Sync Functions
            // =====================

            // Initialize Firebase
            async initFirebase() {
                // Firebase configuration (user needs to add their own config)
                const firebaseConfig = await this.loadData('firebaseConfig') || null;
                if (firebaseConfig && typeof firebase !== 'undefined') {
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        this.state.firebaseInitialized = true;
                        await this.checkAuthState();
                    } catch (error) {
                        console.error('Firebase init error:', error);
                    }
                }
            },

            // Handle cloud sign in
            async handleCloudSignIn() {
                // Check if Firebase is loaded
                if (typeof firebase === 'undefined') {
                    this.showCloudSetupModal();
                    return;
                }

                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('https://www.googleapis.com/auth/drive.file');
                    const result = await firebase.auth().signInWithPopup(provider);
                    const user = result.user;

                    // Save credentials for Drive access
                    const credential = result.credential;
                    this.state.googleAccessToken = credential.accessToken;
                    this.state.currentUser = user;

                    await this.updateCloudSyncUI(user);
                    await this.syncDataToCloud();
                    this.showToast(`Signed in as ${user.displayName}`, 'success');
                } catch (error) {
                    console.error('Sign in error:', error);
                    this.showToast('Sign in failed: ' + error.message, 'error');
                }
            },

            // Check authentication state
            async checkAuthState() {
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().onAuthStateChanged(async (user) => {
                        if (user) {
                            this.state.currentUser = user;
                            await this.updateCloudSyncUI(user);
                            await this.syncDataFromCloud();
                        }
                    });
                }
            },

            // Update cloud sync UI
            async updateCloudSyncUI(user) {
                const syncBar = document.getElementById('cloudSyncBar');
                const accountName = document.getElementById('syncAccountName');
                const statusText = document.getElementById('syncStatusText');
                const signInBtn = document.getElementById('cloudSignInBtn');

                if (user) {
                    syncBar.classList.remove('not-connected');
                    accountName.textContent = user.displayName || user.email;
                    statusText.textContent = 'Data synced across all devices';
                    signInBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Now';
                    signInBtn.onclick = () => this.syncDataToCloud();
                } else {
                    syncBar.classList.add('not-connected');
                    accountName.textContent = 'Not Connected';
                    statusText.textContent = 'Sign in to sync data across devices';
                    signInBtn.innerHTML = '<i class="fab fa-google"></i> Sign In with Google';
                    signInBtn.onclick = () => this.handleCloudSignIn();
                }
            },

            // Sync data to cloud (Firestore)
            async syncDataToCloud() {
                if (!this.state.currentUser || typeof firebase === 'undefined') return;

                try {
                    const db = firebase.firestore();
                    const userId = this.state.currentUser.uid;

                    // Sync all app data
                    const appData = {
                        balances: await this.loadData(this.storageKeys.balances),
                        transactions: await this.loadData(this.storageKeys.transactions),
                        categories: await this.loadData(this.storageKeys.categories),
                        budget: await this.loadData(this.storageKeys.budget),
                        investments: await this.loadData(this.storageKeys.investments),
                        utilities: await this.loadData(this.storageKeys.utilities),
                        settings: await this.loadData(this.storageKeys.settings),
                        lastSync: new Date().toISOString()
                    };

                    await db.collection('users').doc(userId).set(appData, { merge: true });
                    this.showToast('Data synced to cloud', 'success');
                } catch (error) {
                    console.error('Sync error:', error);
                    this.showToast('Sync failed: ' + error.message, 'error');
                }
            },

            // Sync data from cloud
            async syncDataFromCloud() {
                if (!this.state.currentUser || typeof firebase === 'undefined') return;

                try {
                    const db = firebase.firestore();
                    const userId = this.state.currentUser.uid;
                    const doc = await db.collection('users').doc(userId).get();

                    if (doc.exists) {
                        const cloudData = doc.data();
                        const localLastSync = await this.loadData('lastCloudSync');

                        // Only update if cloud data is newer
                        if (!localLastSync || new Date(cloudData.lastSync) > new Date(localLastSync)) {
                            if (cloudData.balances) await this.saveData(this.storageKeys.balances, cloudData.balances);
                            if (cloudData.transactions) await this.saveData(this.storageKeys.transactions, cloudData.transactions);
                            if (cloudData.categories) await this.saveData(this.storageKeys.categories, cloudData.categories);
                            if (cloudData.budget) await this.saveData(this.storageKeys.budget, cloudData.budget);
                            if (cloudData.investments) await this.saveData(this.storageKeys.investments, cloudData.investments);
                            if (cloudData.utilities) await this.saveData(this.storageKeys.utilities, cloudData.utilities);
                            if (cloudData.settings) await this.saveData(this.storageKeys.settings, cloudData.settings);

                            await this.saveData('lastCloudSync', cloudData.lastSync);

                            // Refresh all displays
                            await this.updateBalanceDisplays();
                            await this.updateBudgetDisplay();
                            await this.updateInvestmentDisplay();
                            await this.updateTransactionList();

                            this.showToast('Data synced from cloud', 'info');
                        }
                    }
                } catch (error) {
                    console.error('Sync from cloud error:', error);
                }
            },

            // Show cloud setup modal (for users who need to configure Firebase)
            showCloudSetupModal() {
                const message = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-cloud" style="font-size: 3rem; color: var(--secondary-blue); margin-bottom: 20px;"></i>
                        <h3 style="margin-bottom: 15px;">Cloud Sync Setup</h3>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">
                            To enable cloud sync across devices, you need to:
                        </p>
                        <ol style="text-align: left; margin-bottom: 20px; color: var(--text-secondary);">
                            <li>Create a Firebase project at <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                            <li>Enable Authentication (Google sign-in)</li>
                            <li>Enable Firestore Database</li>
                            <li>Add your Firebase config in Settings</li>
                        </ol>
                        <p style="color: var(--text-tertiary); font-size: 0.9rem;">
                            Alternatively, you can use Google Sheets sync in Settings for basic data backup.
                        </p>
                    </div>
                `;
                this.showToast('Cloud sync requires Firebase setup. Check Settings for details.', 'info', 5000);
            },

            // =====================
            // Image Upload Functions
            // =====================

            // Current uploaded image data
            uploadedImageData: null,

            // Handle image upload
            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showToast('Please select an image file', 'error');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    this.showToast('Image size must be less than 5MB', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.uploadedImageData = {
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                        file: file
                    };

                    // Show preview
                    document.getElementById('imageUploadPlaceholder').style.display = 'none';
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                    document.getElementById('receiptPreview').src = e.target.result;
                    document.getElementById('imageUploadArea').classList.add('has-image');
                };
                reader.readAsDataURL(file);
            },

            // Remove uploaded image
            removeUploadedImage(event) {
                event.stopPropagation();
                this.uploadedImageData = null;
                document.getElementById('txReceiptImage').value = '';
                document.getElementById('imageUploadPlaceholder').style.display = 'block';
                document.getElementById('imagePreviewContainer').style.display = 'none';
                document.getElementById('imageUploadArea').classList.remove('has-image');
            },

            // Upload image to Google Drive
            async uploadImageToGoogleDrive(imageData, transactionId) {
                if (!this.state.googleAccessToken) {
                    console.log('No Google access token available for Drive upload');
                    return null;
                }

                try {
                    // Create metadata
                    const metadata = {
                        name: `receipt_${transactionId}_${imageData.name}`,
                        mimeType: imageData.type,
                        parents: ['appDataFolder'] // Store in app-specific folder
                    };

                    // Create form data
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', imageData.file);

                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.state.googleAccessToken}`
                        },
                        body: form
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.showToast('Receipt uploaded to Google Drive', 'success');
                        return result.id;
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('Drive upload error:', error);
                    this.showToast('Failed to upload to Drive. Image saved locally.', 'warning');
                    return null;
                }
            },

            // Save transaction with image
            async saveTransactionWithImage(transactionData) {
                // If there's an uploaded image, process it
                if (this.uploadedImageData) {
                    // Try to upload to Google Drive if connected
                    if (this.state.googleAccessToken) {
                        const driveFileId = await this.uploadImageToGoogleDrive(this.uploadedImageData, transactionData.id);
                        if (driveFileId) {
                            transactionData.receiptDriveId = driveFileId;
                        }
                    }

                    // Store image data locally as base64 (fallback or primary if not connected)
                    transactionData.receiptImage = this.uploadedImageData.data;
                    transactionData.receiptName = this.uploadedImageData.name;

                    // Clear the upload after saving
                    this.removeUploadedImage({ stopPropagation: () => {} });
                }

                return transactionData;
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            AdvancedFinanceApp.init();
        });

        // Register service worker for PWA capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
            });
        }
    </script>
</body>
</html>
